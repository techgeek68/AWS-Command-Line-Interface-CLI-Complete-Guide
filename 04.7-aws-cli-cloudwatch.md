# AWS CLI â€“ CloudWatch (Logs & Metrics) Guide

## Table of Contents
1. [Overview](#overview)
2. [Log Groups & Streams](#1-log-groups--streams)
3. [Fetching Log Events](#2-fetching-log-events)
4. [Tail / Filtering](#3-tail--filtering)
5. [Metrics](#4-metrics)
6. [Alarms](#5-alarms)
7. [Insights Queries](#6-insights-queries)
8. [Best Practices](#7-best-practices)
9. [Troubleshooting](#8-troubleshooting)

---

## Overview
Amazon CloudWatch provides observability: metrics, logs, alarms, and events. The CLI facilitates log ingestion queries, metric publishing, and alarm management. This guide focuses on Logs & Metrics essentials.

---

## 1. Log Groups & Streams
List log groups:
```bash
aws logs describe-log-groups --query "logGroups[].logGroupName"
```

Create log group:
```bash
aws logs create-log-group --log-group-name /app/api
```

List streams:
```bash
aws logs describe-log-streams \
  --log-group-name /app/api \
  --order-by LastEventTime \
  --descending \
  --max-items 5
```

---

## 2. Fetching Log Events
```bash
aws logs get-log-events \
  --log-group-name /app/api \
  --log-stream-name stream-1 \
  --limit 20
```

---

## 3. Tail / Filtering
Tail:
```bash
aws logs tail /app/api --since 10m
```

Filter pattern:
```bash
aws logs filter-log-events \
  --log-group-name /app/api \
  --filter-pattern '"ERROR"' \
  --limit 50
```

---

## 4. Metrics
List metrics:
```bash
aws cloudwatch list-metrics --namespace AWS/EC2 --metric-name CPUUtilization
```

Publish custom metric:
```bash
aws cloudwatch put-metric-data \
  --namespace Custom/App \
  --metric-data '[
    {"MetricName":"RequestCount","Unit":"Count","Value":1}
  ]'
```

Publish with dimensions:
```bash
aws cloudwatch put-metric-data \
  --namespace Custom/App \
  --metric-data '[
    {"MetricName":"LatencyMs","Dimensions":[{"Name":"Service","Value":"UserAPI"}],"StatisticValues":{"SampleCount":1,"Sum":240,"Minimum":240,"Maximum":240},"Unit":"Milliseconds"}
  ]'
```

Get statistics:
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/EC2 \
  --metric-name CPUUtilization \
  --statistics Average \
  --dimensions Name=InstanceId,Value=i-0123456789abcdef0 \
  --start-time 2025-08-21T00:00:00Z \
  --end-time 2025-08-22T00:00:00Z \
  --period 300
```

---

## 5. Alarms
Create:
```bash
aws cloudwatch put-metric-alarm \
  --alarm-name HighCPU \
  --metric-name CPUUtilization \
  --namespace AWS/EC2 \
  --statistic Average \
  --period 300 \
  --threshold 80 \
  --comparison-operator GreaterThanThreshold \
  --dimensions Name=InstanceId,Value=i-0123456789abcdef0 \
  --evaluation-periods 2 \
  --alarm-actions arn:aws:sns:us-east-1:123456789012:NotifyOps
```

Describe:
```bash
aws cloudwatch describe-alarms --alarm-names HighCPU
```

Delete:
```bash
aws cloudwatch delete-alarms --alarm-names HighCPU
```

---

## 6. Insights Queries
Start query:
```bash
QUERY_ID=$(aws logs start-query \
  --log-group-name /app/api \
  --start-time $(date -d '15 minutes ago' +%s) \
  --end-time $(date +%s) \
  --query-string 'fields @timestamp, @message | filter @message like /ERROR/ | sort @timestamp desc | limit 20' \
  --query 'queryId' --output text)
```

Check status:
```bash
aws logs get-query-results --query-id "$QUERY_ID"
```

---

## 7. Best Practices
- Structured JSON logs.
- Set retention policies:
```bash
aws logs put-retention-policy --log-group-name /app/api --retention-in-days 30
```
- Avoid metric cardinality explosions.
- Use anomaly detection for dynamic thresholds.
- Aggregate metrics to reduce cost.

---

## 8. Troubleshooting
| Issue | Cause | Fix |
|-------|-------|-----|
| Missing logs | Agent / role misconfig | Verify IAM & agent status |
| Incomplete query | Narrow time window | Expand start/end |
| High cost | Long retention / many metrics | Reduce retention, aggregate |
| Alarm not firing | Eval periods not met | Adjust threshold / periods |
| AccessDenied | Missing logs/cloudwatch actions | Add `logs:Describe*`, `logs:Get*` etc. |

Retention audit:
```bash
aws logs describe-log-groups --query "logGroups[?retentionInDays==null].logGroupName"
```

---
