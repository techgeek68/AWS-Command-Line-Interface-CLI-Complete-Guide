# AWS CLI â€“ EC2 Guide

## Table of Contents
1. [Overview](#overview)
2. [Key Pairs](#1-key-pairs)
3. [Security Groups](#2-security-groups)
4. [Instance Lifecycle](#3-instance-lifecycle)
5. [Describing Common Resources](#4-describe-common-resources)
6. [SSH Access](#5-ssh-access)
7. [Best Practices](#6-best-practices)
8. [Troubleshooting](#7-troubleshooting)

---

## Overview
Amazon EC2 provides virtual server instances. The AWS CLI enables automation for instance lifecycle, key pairs, security groups, networking, and metadata queries. This guide covers frequently used foundational operations.

---

## 1. Key Pairs
(Create, permission, delete)

Create and save a key pair (Linux/macOS):
```bash
aws ec2 create-key-pair \
  --key-name MyProdKey \
  --key-type rsa \
  --key-format pem \
  --query 'KeyMaterial' \
  --output text > MyProdKey.pem && chmod 400 MyProdKey.pem
```

Windows (Command Prompt):
```
aws ec2 create-key-pair --key-name MyProdKey --key-type rsa --key-format pem --query "KeyMaterial" --output text > MyProdKey.pem
icacls MyProdKey.pem /inheritance:r /grant:r %USERNAME%:R
```

Windows (PowerShell):
```powershell
aws.exe ec2 create-key-pair --key-name MyProdKey --key-type rsa --key-format pem --query "KeyMaterial" --output text > MyProdKey.pem
icacls MyProdKey.pem /inheritance:r /grant:r "$($env:USERNAME):(R)"
```

Delete key pair (AWS side):
```bash
aws ec2 delete-key-pair --key-name MyProdKey
```

---

## 2. Security Groups

Get first VPC ID (bash):
```bash
VPC_ID=$(aws ec2 describe-vpcs --query "Vpcs[0].VpcId" --output text)
echo "$VPC_ID"
```

PowerShell:
```powershell
$VPC_ID = (aws.exe ec2 describe-vpcs --query "Vpcs[0].VpcId" --output text)
$VPC_ID
```

Create security group:
```bash
SG_JSON=$(aws ec2 create-security-group \
  --group-name WebSG \
  --description "Web access SG" \
  --vpc-id "$VPC_ID")
SG_ID=$(echo "$SG_JSON" | jq -r '.GroupId')
echo "$SG_ID"
```

PowerShell:
```powershell
$create = aws.exe ec2 create-security-group --group-name WebSG --description "Web access SG" --vpc-id $VPC_ID --output json
$SG_ID = (ConvertFrom-Json $create).GroupId
$SG_ID
```

Add rules (ingress):
```bash
# SSH
aws ec2 authorize-security-group-ingress --group-id "$SG_ID" --protocol tcp --port 22 --cidr 203.0.113.25/32
# HTTP
aws ec2 authorize-security-group-ingress --group-id "$SG_ID" --protocol tcp --port 80 --cidr 0.0.0.0/0
# HTTPS
aws ec2 authorize-security-group-ingress --group-id "$SG_ID" --protocol tcp --port 443 --cidr 0.0.0.0/0
```

List security group:
```bash
aws ec2 describe-security-groups --group-ids "$SG_ID"
```

Delete:
```bash
aws ec2 delete-security-group --group-id "$SG_ID"
```

---

## 3. Instance Lifecycle

List instances (all):
```bash
aws ec2 describe-instances
```

List running instances (IDs):
```bash
aws ec2 describe-instances \
  --filters Name=instance-state-name,Values=running \
  --query "Reservations[].Instances[].InstanceId" \
  --output text
```

Start / Stop / Terminate:
```bash
aws ec2 start-instances --instance-ids i-0123456789abcdef0
aws ec2 stop-instances --instance-ids i-0123456789abcdef0
aws ec2 terminate-instances --instance-ids i-0123456789abcdef0
```

Create instance (basic):
```bash
aws ec2 run-instances \
  --image-id ami-0abcdef1234567890 \
  --count 1 \
  --instance-type t3.micro \
  --key-name MyProdKey \
  --security-group-ids "$SG_ID" \
  --subnet-id subnet-0123456789abcdef0 \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=DemoInstance}]'
```

---

## 4. Describe Common Resources

Describe AMIs (self):
```bash
aws ec2 describe-images --owners self
```

Describe instance types:
```bash
aws ec2 describe-instance-types --filters Name=processor-info.supported-architecture,Values=x86_64
```

---

## 5. SSH Access

Syntax:
```bash
ssh -i MyProdKey.pem ec2-user@ec2-203-0-113-10.compute-1.amazonaws.com
```
Common usernames:
| AMI Family | User |
|------------|------|
| Amazon Linux | ec2-user |
| Ubuntu | ubuntu |
| RHEL | ec2-user / root |
| CentOS | centos |
| Debian | admin / debian |

Windows EC2 (password data):
```bash
aws ec2 get-password-data --instance-id i-0123456789abcdef0 --priv-launch-key MyProdKey.pem
```

---

## 6. Best Practices
- Restrict SSH (22) to known IPs (avoid `0.0.0.0/0`).
- Use Systems Manager Session Manager instead of direct SSH where possible.
- Tag instances for cost allocation: `--tag-specifications`.
- Use IAM roles for EC2 (Instance Profiles) not embedded credentials.
- Clean up unused security groups, Elastic IPs, and stopped instances.

---

## 7. Troubleshooting
| Issue | Cause | Fix |
|-------|-------|-----|
| Timeout on SSH | SG or NACL blocked | Verify ingress 22 & public IP |
| `UnauthorizedOperation` | Missing IAM perms | Add required `ec2:Describe*` or action |
| Stuck stopping | Agent / volumes | Try stop again / force only if necessary |
| Wrong AMI | Region mismatch | Query AMI per region |
| Key permission denied | Insecure key file | `chmod 400 MyProdKey.pem` / `icacls` fix |

---
