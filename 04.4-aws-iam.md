# AWS CLI â€“ IAM Guide

## Table of Contents
1. [Overview](#overview)
2. [Users](#1-users)
3. [Policies](#2-policies)
4. [Roles](#3-roles)
5. [Access Keys](#4-access-keys)
6. [Policy Evaluation Helpers](#5-policy-evaluation-helpers)
7. [Best Practices](#6-best-practices)
8. [Troubleshooting](#7-troubleshooting)

---

## Overview
AWS Identity and Access Management (IAM) governs users, groups, roles, and policies. The CLI enables creation and management of identities and permission boundaries. Prefer roles + temporary credentials over long-lived user keys.

---

## 1. Users
List users:
```bash
aws iam list-users
```

Create user:
```bash
aws iam create-user --user-name DevUser
```

Attach managed policy:
```bash
aws iam attach-user-policy \
  --user-name DevUser \
  --policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess
```

List attached:
```bash
aws iam list-attached-user-policies --user-name DevUser
```

Delete user:
```bash
aws iam delete-user --user-name DevUser
```

---

## 2. Policies
List AWS managed policies (filter):
```bash
aws iam list-policies --scope AWS --query "Policies[?contains(PolicyName,'ReadOnly')].PolicyName"
```

Get default version:
```bash
POL_ARN=arn:aws:iam::aws:policy/ReadOnlyAccess
VER=$(aws iam get-policy --policy-arn "$POL_ARN" --query "Policy.DefaultVersionId" --output text)
aws iam get-policy-version --policy-arn "$POL_ARN" --version-id "$VER" --query "PolicyVersion.Document"
```

Inline policy:
```bash
aws iam put-user-policy \
  --user-name DevUser \
  --policy-name AllowListS3 \
  --policy-document '{
    "Version":"2012-10-17",
    "Statement":[{"Effect":"Allow","Action":["s3:ListAllMyBuckets"],"Resource":"*"}]
  }'
```

---

## 3. Roles
Trust policy (`trust.json`):
```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {"AWS": "arn:aws:iam::123456789012:root"},
    "Action": "sts:AssumeRole"
  }]
}
```

Create role:
```bash
aws iam create-role \
  --role-name CrossAccountReadRole \
  --assume-role-policy-document file://trust.json
```

Attach policy:
```bash
aws iam attach-role-policy \
  --role-name CrossAccountReadRole \
  --policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess
```

Delete role sequence:
```bash
aws iam detach-role-policy --role-name CrossAccountReadRole --policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess
aws iam delete-role --role-name CrossAccountReadRole
```

Assume role:
```bash
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/CrossAccountReadRole \
  --role-session-name testSession
```

---

## 4. Access Keys
Create:
```bash
aws iam create-access-key --user-name DevUser
```

List:
```bash
aws iam list-access-keys --user-name DevUser
```

Deactivate:
```bash
aws iam update-access-key --user-name DevUser --access-key-id AKIA... --status Inactive
```

Delete:
```bash
aws iam delete-access-key --user-name DevUser --access-key-id AKIA...
```

---

## 5. Policy Evaluation Helpers
Simulate:
```bash
aws iam simulate-principal-policy \
  --policy-source-arn arn:aws:iam::123456789012:user/DevUser \
  --action-names s3:ListAllMyBuckets ec2:DescribeInstances
```

Validate policy:
```bash
aws iam validate-policy --policy-document file://policy.json
```

---

## 6. Best Practices
- Prefer roles with STS over access keys.
- Enforce MFA using condition keys.
- Principle of least privilege from the start.
- Rotate access keys; minimize concurrent active keys.
- Use permission boundaries + SCPs for guardrails.
- Tag roles (e.g., `Owner`, `Env`).

---

## 7. Troubleshooting
| Issue | Cause | Fix |
|-------|-------|-----|
| AccessDenied | Missing action / explicit deny | Review IAM + SCP + boundary layers |
| Cannot delete user | Residual resources | Remove keys, policies, groups, login profile |
| AssumeRole fails | Trust policy missing principal | Update trust JSON |
| Policy size error | Document too large | Split into multiple policies |
| MFA required | Condition enforced | Use `get-session-token` / role with MFA |

---
