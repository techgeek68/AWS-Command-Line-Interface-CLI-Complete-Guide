# AWS CLI — SNS (Simple Notification Service) Operations Guide

---
> Replace sample ARNs (`arn:aws:sns:us-east-1:123456789012:...`) / account IDs/emails with your own.
---
> Covers: Topics, Subscriptions (Email / SQS / Lambda / HTTP / SMS), Message Publishing (JSON, attributes, FIFO, direct SMS), Policies, 
Encryption (KMS), Delivery Status, Message Filtering, Tagging, Integrations, Troubleshooting, and Cleanup.
---

## Table of Contents
1. Overview  
2. Quick Reference Variables  
3. Topics (Create / List / Delete / Attributes)  
4. Subscriptions (Create / Confirm / List / Unsubscribe)  
5. Message Publishing (Standard & FIFO)  
6. Message Attributes & Filtering  
7. SQS & Lambda Integration  
8. Access Policies & Permissions  
9. Encryption (KMS) & SSE  
10. Delivery Status & Logs  
11. SMS & Mobile Push (Brief)  
12. Tagging  
13. Best Practices  
14. Troubleshooting  
15. Automation Snippets  
16. Cleanup Sequences  
17. Notes

---

## 1. Overview
Amazon SNS is a fully managed pub/sub service supporting push to multiple protocols (Email, SQS, Lambda, HTTP(S), SMS, Mobile Push, Firehose via subscription).  
Key concepts:
- Topic: Named resource clients publish messages to.
- Subscription: Endpoint receiving published messages.
- Message Attributes: Metadata for filtering & routing.
- Filter Policy: JSON policy at subscription controlling message delivery.
- FIFO Topics: Guarantee ordering per message group & exactly-once publish (suffix `.fifo`).
- Access Policy: Resource-based policy controlling who can publish / subscribe.
- Encryption: KMS-managed server-side encryption for topic storage.
- Delivery Status Logging: CloudWatch logs / metrics for successes/failures (HTTP/S, Lambda, SMS).

---

## 2. Quick Reference Variables
```bash
export ACCOUNT_ID=123456789012
export REGION=us-east-1
export TOPIC_NAME=orders-events
export FIFO_TOPIC_NAME=orders-events.fifo
export EMAIL=devops@example.com
export SQS_QUEUE_NAME=orders-queue
export LAMBDA_FUNC=processOrder
export KMS_KEY_ARN=arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555
```

---

## 3. Topics (Create / List / Delete / Attributes)

### 3.1 Create topic (Standard)
Syntax:
```bash
aws sns create-topic --name <TOPIC_NAME>
```
Example:
```bash
aws sns create-topic --name orders-events
# Output includes "TopicArn"
```

### 3.2 Create FIFO topic
Syntax:
```bash
aws sns create-topic --name <TOPIC_NAME>.fifo --attributes FifoTopic=true,ContentBasedDeduplication=true
```
Example:
```bash
aws sns create-topic \
  --name orders-events.fifo \
  --attributes FifoTopic=true,ContentBasedDeduplication=true
```

### 3.3 List topics
Syntax:
```bash
aws sns list-topics
```
Example (names only):
```bash
aws sns list-topics --query 'Topics[].TopicArn'
```

### 3.4 Get topic attributes
Syntax:
```bash
aws sns get-topic-attributes --topic-arn <TOPIC_ARN>
```
Example:
```bash
TOPIC_ARN=$(aws sns create-topic --name orders-events --query 'TopicArn' --output text)
aws sns get-topic-attributes --topic-arn $TOPIC_ARN \
  --query 'Attributes.{DisplayName:DisplayName,KmsMasterKeyId:KmsMasterKeyId,Policy:Policy}'
```

### 3.5 Set topic attributes (DisplayName: affects SMS subject prefix)
Syntax:
```bash
aws sns set-topic-attributes --topic-arn <TOPIC_ARN> --attribute-name <NAME> --attribute-value <VALUE>
```
Example:
```bash
aws sns set-topic-attributes \
  --topic-arn $TOPIC_ARN \
  --attribute-name DisplayName \
  --attribute-value "Orders"
```

### 3.6 Delete topic
Syntax:
```bash
aws sns delete-topic --topic-arn <TOPIC_ARN>
```
Example:
```bash
aws sns delete-topic --topic-arn $TOPIC_ARN
```

---

## 4. Subscriptions (Create / Confirm / List / Unsubscribe)

### 4.1 Subscribe Email
Syntax:
```bash
aws sns subscribe --topic-arn <TOPIC_ARN> --protocol email --notification-endpoint <EMAIL>
```
Example:
```bash
aws sns subscribe \
  --topic-arn $TOPIC_ARN \
  --protocol email \
  --notification-endpoint $EMAIL
# Recipient must confirm via email link before active
```

### 4.2 Subscribe SQS queue
Requires queue access policy allowing SNS. See section 8.
```bash
SQS_QUEUE_URL=$(aws sqs get-queue-url --queue-name $SQS_QUEUE_NAME --query 'QueueUrl' --output text)
SQS_QUEUE_ARN=$(aws sqs get-queue-attributes --queue-url $SQS_QUEUE_URL --attribute-names QueueArn --query 'Attributes.QueueArn' --output text)

aws sns subscribe \
  --topic-arn $TOPIC_ARN \
  --protocol sqs \
  --notification-endpoint $SQS_QUEUE_ARN
```

### 4.3 Subscribe Lambda
```bash
LAMBDA_ARN=$(aws lambda get-function --function-name $LAMBDA_FUNC --query 'Configuration.FunctionArn' --output text)
aws sns subscribe \
  --topic-arn $TOPIC_ARN \
  --protocol lambda \
  --notification-endpoint $LAMBDA_ARN
```
(Needs permission: `aws lambda add-permission` — see section 8.)

### 4.4 Subscribe HTTPS endpoint
```bash
aws sns subscribe \
  --topic-arn $TOPIC_ARN \
  --protocol https \
  --notification-endpoint https://hooks.example.com/sns/orders
```
(Endpoint must respond to confirmation request.)

### 4.5 List subscriptions by topic
Syntax:
```bash
aws sns list-subscriptions-by-topic --topic-arn <TOPIC_ARN>
```
Example:
```bash
aws sns list-subscriptions-by-topic --topic-arn $TOPIC_ARN \
  --query 'Subscriptions[].{Protocol:Protocol,Endpoint:Endpoint,SubArn:SubscriptionArn}'
```

### 4.6 Unsubscribe
Syntax:
```bash
aws sns unsubscribe --subscription-arn <SUBSCRIPTION_ARN>
```
Example:
```bash
aws sns unsubscribe --subscription-arn arn:aws:sns:us-east-1:123456789012:orders-events:abcdef12-3456-7890-abcd-ef1234567890
```

---

## 5. Message Publishing (Standard & FIFO)

### 5.1 Publish (basic)
Syntax:
```bash
aws sns publish --topic-arn <TOPIC_ARN> --subject "<SUBJECT>" --message "<MESSAGE>"
```
Example:
```bash
aws sns publish \
  --topic-arn $TOPIC_ARN \
  --subject "Order Created" \
  --message "Order O10002 created at $(date -u +%FT%TZ)"
```

### 5.2 Publish structured JSON with message attributes (using CLI JSON file)
File: `msg.json`
```json
{
  "Message": "Order O10003 status=SHIPPED",
  "Subject": "Order Update",
  "MessageAttributes": {
    "eventType": {"DataType": "String", "StringValue": "OrderStatus"},
    "status":    {"DataType": "String", "StringValue": "SHIPPED"},
    "priority":  {"DataType": "Number", "StringValue": "5"}
  }
}
```
Publish:
```bash
aws sns publish --topic-arn $TOPIC_ARN --cli-input-json file://msg.json
```

### 5.3 Publish with message structure (JSON per protocol)
```bash
aws sns publish \
  --topic-arn $TOPIC_ARN \
  --message '{"default":"Generic fallback","email":"Email body","sqs":"{\"event\":\"Order\"}"}' \
  --message-structure json
```

### 5.4 Publish FIFO (ordering & dedup)
Syntax:
```bash
aws sns publish \
  --topic-arn <FIFO_TOPIC_ARN> \
  --message "<MSG>" \
  --message-group-id <GROUP_ID> \
  [--message-deduplication-id <DEDUP_ID>]
```
Example:
```bash
FIFO_ARN=$(aws sns create-topic --name $FIFO_TOPIC_NAME --attributes FifoTopic=true --query 'TopicArn' --output text)
aws sns publish \
  --topic-arn $FIFO_ARN \
  --message '{"orderId":"O10005","event":"CREATED"}' \
  --message-group-id Order-O10005
```
(With ContentBasedDeduplication enabled, omit `--message-deduplication-id`.)

### 5.5 Publish direct SMS (no topic)
```bash
aws sns publish \
  --phone-number +15555550123 \
  --message "Your order has shipped."
```

---

## 6. Message Attributes & Filtering

### 6.1 Subscription with filter policy
Create filter for only SHIPPED status.
```bash
FILTER='{"status":["SHIPPED"],"eventType":["OrderStatus"]}'
aws sns subscribe \
  --topic-arn $TOPIC_ARN \
  --protocol email \
  --notification-endpoint shipping-alerts@example.com \
  --attributes "FilterPolicy=$FILTER"
```

### 6.2 Set filter policy on existing subscription
```bash
aws sns set-subscription-attributes \
  --subscription-arn <SUB_ARN> \
  --attribute-name FilterPolicy \
  --attribute-value '{"priority":[{"numeric":[">=",5]}]}'
```

### 6.3 View subscription attributes
```bash
aws sns get-subscription-attributes --subscription-arn <SUB_ARN>
```

---

## 7. SQS & Lambda Integration

### 7.1 SQS queue policy allowing SNS topic to send
Queue attributes file `sqs-policy.json`:
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Principal":"*",
      "Action":"SQS:SendMessage",
      "Resource":"arn:aws:sqs:us-east-1:123456789012:orders-queue",
      "Condition":{
        "ArnEquals":{"aws:SourceArn":"arn:aws:sns:us-east-1:123456789012:orders-events"}
      }
    }
  ]
}
```
Apply:
```bash
aws sqs set-queue-attributes \
  --queue-url $SQS_QUEUE_URL \
  --attributes file://<(jq -c '. | {"Policy": tostring}' sqs-policy.json)
```

### 7.2 Lambda add permission for SNS
```bash
aws lambda add-permission \
  --function-name $LAMBDA_FUNC \
  --statement-id sns-invoke \
  --action lambda:InvokeFunction \
  --principal sns.amazonaws.com \
  --source-arn $TOPIC_ARN
```

---

## 8. Access Policies & Permissions

### 8.1 Allow another account to publish
Policy snippet (file `sns-policy.json`):
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Sid":"AllowExternalAccountPublish",
      "Effect":"Allow",
      "Principal":{"AWS":"arn:aws:iam::098765432109:root"},
      "Action":"SNS:Publish",
      "Resource":"arn:aws:sns:us-east-1:123456789012:orders-events"
    }
  ]
}
```
Apply:
```bash
aws sns set-topic-attributes \
  --topic-arn $TOPIC_ARN \
  --attribute-name Policy \
  --attribute-value file://sns-policy.json
```

### 8.2 View topic policy
```bash
aws sns get-topic-attributes --topic-arn $TOPIC_ARN --query 'Attributes.Policy'
```

---

## 9. Encryption (KMS) & SSE

### 9.1 Create encrypted topic
```bash
aws sns create-topic \
  --name orders-secure \
  --attributes KmsMasterKeyId=$KMS_KEY_ARN
```

### 9.2 Add encryption to existing topic
```bash
aws sns set-topic-attributes \
  --topic-arn $TOPIC_ARN \
  --attribute-name KmsMasterKeyId \
  --attribute-value $KMS_KEY_ARN
```

### 9.3 Confirm encryption attribute
```bash
aws sns get-topic-attributes --topic-arn $TOPIC_ARN \
  --query 'Attributes.KmsMasterKeyId'
```

---

## 10. Delivery Status & Logs

### 10.1 Enable delivery status logging (HTTP success/failure)
```bash
aws sns set-topic-attributes \
  --topic-arn $TOPIC_ARN \
  --attribute-name HTTPSuccessFeedbackRoleArn \
  --attribute-value arn:aws:iam::123456789012:role/SNSDeliveryRole
```
(Configure roles & CloudWatch logs per doc; placeholders shown.)

### 10.2 CloudWatch metrics names (reference)
- `NumberOfMessagesPublished`
- `NumberOfNotificationsDelivered`
- `NumberOfNotificationsFailed`
- `PublishSize`

### 10.3 Get published messages metric (last 10m)
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/SNS \
  --metric-name NumberOfMessagesPublished \
  --dimensions Name=TopicName,Value=orders-events \
  --start-time "$(date -u -d '10 minutes ago' +%FT%TZ)" \
  --end-time "$(date -u +%FT%TZ)" \
  --period 60 \
  --statistics Sum \
  --query 'Datapoints|sort_by(@,&Timestamp)[].{T:Timestamp,Sum:Sum}'
```

---

## 11. SMS & Mobile Push (Brief)

### 11.1 Set account-wide SMS spend limit (example $5)
```bash
aws sns set-sms-attributes --attributes MonthlySpendLimit=5
```

### 11.2 Publish SMS
```bash
aws sns publish --phone-number +15555550123 --message "2FA code 123456"
```

### 11.3 View SMS attributes
```bash
aws sns get-sms-attributes --attributes names=MonthlySpendLimit,DeliveryStatusIAMRole
```

(Mobile Push requires platform application setup; omitted for brevity.)

---

## 12. Tagging

### 12.1 Tag topic
```bash
aws sns tag-resource \
  --resource-arn $TOPIC_ARN \
  --tags Key=Env,Value=dev Key=Service,Value=Orders
```

### 12.2 List tags
```bash
aws sns list-tags-for-resource --resource-arn $TOPIC_ARN
```

### 12.3 Untag
```bash
aws sns untag-resource --resource-arn $TOPIC_ARN --tag-keys Env
```

---

## 13. Best Practices
- Use message attributes + filter policies to reduce fan-out noise (publish once, selective delivery).
- Prefer FIFO topics for strict ordering & exactly-once semantics; ensure subscriptions (SQS FIFO) support ordering.
- Encrypt topics with customer-managed KMS for regulated data.
- Apply least-privilege topic policies: limit publishers to specific principals.
- Monitor CloudWatch metrics for publish & delivery failures; set alarms.
- Use dead-letter handling at subscriber end (e.g., SQS DLQ / Lambda retries) rather than relying solely on SNS.
- Avoid large payloads—SNS limit is (256 KB). For larger data, store in S3 and publish reference.
- Use structured JSON payloads for downstream parsing consistency.
- Tag topics for cost & ownership clarity (Env, Team, Service).
- Remove unused subscriptions & topics to reduce accidental notifications.

---

## 14. Troubleshooting
| Issue | Symptom | Likely Cause | Resolution |
|-------|---------|--------------|-----------|
| Email subscription stuck in PendingConfirmation | No messages delivered | User not clicking confirm link | Resend subscription, check spam |
| AccessDenied when publishing | CLI error | Missing SNS:Publish or topic policy restricts principal | Update IAM policy or resource policy |
| Messages not arriving at SQS | SQS queue empty | Queue policy missing SourceArn condition or filter mismatch | Fix queue policy; verify filter policy vs message attributes |
| Lambda not invoked | No CloudWatch log entries | Missing lambda add-permission | Run add-permission with SourceArn topic |
| FIFO publish fails | Error about missing group id | Missing --message-group-id on FIFO publish | Include message-group-id parameter |
| FilterPolicy rejects all | No deliveries | Attribute type mismatch (Number vs String) | Align attribute data types with policy |
| KMS AccessDenied | Publish fails | Execution principal lacks kms:GenerateDataKey/Decrypt | Add KMS key policy / IAM permission |
| HTTP subscription failed confirmations | Endpoint not validated | Endpoint not responding with required token | Implement / confirm subscription response logic |
| Throttling / Rate exceeded | API throttling | Too many publish API calls | Implement exponential backoff |
| SMS not delivered | No message on device | Region restrictions / sandbox / spend limit | Adjust SMS attributes; verify phone validity |

---

## 15. Automation Snippets

### 15.1 Publish test batch (loop)
```bash
for i in $(seq 1 5); do
  aws sns publish --topic-arn $TOPIC_ARN --message "Test message $i at $(date -u +%T)"
done
```

### 15.2 Filtered publish (only high priority)
```bash
aws sns publish \
  --topic-arn $TOPIC_ARN \
  --message "Critical order event" \
  --message-attributes '{"priority":{"DataType":"Number","StringValue":"10"}}'
```

### 15.3 Recreate topic idempotently
```bash
TOPIC_ARN=$(aws sns create-topic --name $TOPIC_NAME --query 'TopicArn' --output text)
echo "Topic ARN: $TOPIC_ARN"
```

### 15.4 Sync Lambda permission with alias
```bash
aws lambda add-permission \
  --function-name ${LAMBDA_FUNC}:prod \
  --statement-id sns-invoke-prod \
  --action lambda:InvokeFunction \
  --principal sns.amazonaws.com \
  --source-arn $TOPIC_ARN
```

---

## 16. Cleanup Sequences

### 16.1 Remove all subscriptions for a topic
```bash
aws sns list-subscriptions-by-topic --topic-arn $TOPIC_ARN \
  --query 'Subscriptions[].SubscriptionArn' --output text | tr '\t' '\n' | while read S; do
    [ "$S" != "PendingConfirmation" ] && aws sns unsubscribe --subscription-arn "$S"
  done
```

### 16.2 Delete topic(s) by prefix
```bash
aws sns list-topics --query 'Topics[].TopicArn' --output text | tr '\t' '\n' | \
  grep ":orders" | while read T; do
    aws sns delete-topic --topic-arn "$T"
  done
```

### 16.3 Remove lambda invoke permission
```bash
aws lambda remove-permission \
  --function-name $LAMBDA_FUNC \
  --statement-id sns-invoke 2>/dev/null || true
```

### 16.4 Remove anomaly detection (not SNS specific – placeholder)
(N/A for SNS; metrics only.)

---

## 17. Notes
- SNS message size limit is currently 256 KB (including attributes).
- FIFO topics require FIFO-compatible subscribers (e.g., SQS FIFO) to preserve ordering end-to-end.
- Content-based dedupe hashes the message body; changing the timestamp or metadata changes the hash.
- Filter policies are case-sensitive; numeric conditions must use `{"numeric":[">=",5]}` format.
- SMS spend limits & sandbox vary by region; production SMS may require registration (10DLC, etc.).
- Cross-account publish requires both IAM permission & topic resource policy.
- For high throughput fan-out, chain SNS → SQS per subscriber to decouple consumption rates.

---

## 18. Revision
2025-08-28 (Initial enriched version with real examples)
