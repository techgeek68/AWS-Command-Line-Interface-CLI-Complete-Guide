# AWS SDK Developer Guide — Node.js (aws-sdk v3)

> Focus: Install, credential sourcing, modular clients, ESM/CommonJS usage, pagination, retries, waiters, examples (list regions, minimal key pair + security group), best practices.

## Table of Contents
1. Overview
2. Prerequisites
3. Install & Project Setup
4. Credential Sources
5. Example Scripts
6. Modular Clients & Imports
7. Pagination & Waiters
8. Retries, Middleware & Timeouts
9. Logging & Instrumentation
10. Testing Approaches
11. Common Errors
12. Best Practices

---

## 1. Overview
AWS SDK for JavaScript v3 is modular—import only the service clients required (`@aws-sdk/client-ec2`, etc.). Supports Promise-based APIs, middleware stack customization, and Node.js or browser usage.

---

## 2. Prerequisites
- Node.js 16+ (prefer LTS).
- npm or yarn / pnpm.
- AWS credentials via environment, shared config, SSO, or STS.
- Modern ESM recommended (or CommonJS fallback).

---

## 3. Install & Project Setup
```bash
mkdir aws-node && cd aws-node
npm init -y
npm install @aws-sdk/client-ec2
```
Optional tools:
```bash
npm install --save-dev typescript @types/node
```

---

## 4. Credential Sources
Order (default credential provider chain):
1. Environment variables (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`)
2. Shared config (`~/.aws/credentials`)
3. SSO token cache
4. ECS / EKS / EC2 instance metadata (IAM role)

Explicit region:
```js
const client = new EC2Client({ region: "us-east-1" });
```

---

## 5. Example Scripts
See separate files:
- `list-regions.js` (ESM)
- `create-key-and-sg.mjs`

Run:
```bash
node list-regions.js
```

---

## 6. Modular Clients & Imports
Named command pattern:
```js
import { EC2Client, DescribeInstancesCommand } from "@aws-sdk/client-ec2";
const client = new EC2Client({});
const cmd = new DescribeInstancesCommand({});
const resp = await client.send(cmd);
```

---

## 7. Pagination & Waiters

### Pagination
Some clients expose paginator utilities via `@aws-sdk/lib-dynamodb` or service-specific helpers. If not, emulate:
```js
let nextToken;
do {
  const out = await client.send(new DescribeInstancesCommand({ NextToken: nextToken }));
  // process out.Reservations
  nextToken = out.NextToken;
} while (nextToken);
```

### Waiters
Use `@aws-sdk/util-waiter`:
```js
import { waitUntilInstanceRunning } from "@aws-sdk/client-ec2";
await waitUntilInstanceRunning({ client, maxWaitTime: 300 }, { InstanceIds: ["i-123"] });
```

---

## 8. Retries, Middleware & Timeouts
Default retry strategy is standard (max attempts from env `AWS_MAX_ATTEMPTS` or config). Custom:
```js
import { EC2Client, StandardRetryStrategy } from "@aws-sdk/client-ec2";
const retryStrategy = new StandardRetryStrategy(() => Promise.resolve(5));
const client = new EC2Client({ retryStrategy });
```
HTTP timeouts with Node HTTP handler (advanced). Middleware example (logging):
```js
client.middlewareStack.add(
  (next, ctx) => async (args) => {
    const start = Date.now();
    const result = await next(args);
    console.log(ctx.commandName, Date.now() - start, "ms");
    return result;
  },
  { step: "initialize" }
);
```

---

## 9. Logging & Instrumentation
- Add middleware for timing & correlation IDs.
- Integrate with OpenTelemetry (`@opentelemetry/api` + instrumentation packages).
- Set environment variable `AWS_SDK_JS_SUPPRESS_MAINTENANCE_MODE_MESSAGE=1` to silence maintenance notices.

---

## 10. Testing Approaches
| Tool | Use |
|------|-----|
| jest / vitest | Unit testing |
| aws-sdk-client-mock | Mock service commands |
| LocalStack | Local endpoints for integration |
| Nock | HTTP-layer mocking |

Example (aws-sdk-client-mock):
```js
import { mockClient } from "aws-sdk-client-mock";
import { EC2Client, DescribeRegionsCommand } from "@aws-sdk/client-ec2";
const ec2Mock = mockClient(EC2Client);
ec2Mock.on(DescribeRegionsCommand).resolves({ Regions: [{ RegionName: "us-east-1" }] });
```

---

## 11. Common Errors
| Error | Cause | Resolution |
|-------|-------|-----------|
| `UnrecognizedClientException` | Bad credentials | Refresh keys / role |
| `CredentialsProviderError` | No providers found | Configure env/profile / SSO login |
| `AccessDeniedException` | Permission gap | Update IAM policy |
| Throttling | Rate exceeded | Backoff or increase concurrency tokens |
| Network timeout | Proxy/firewall | Configure proxy or VPC endpoints if applicable |

---

## 12. Best Practices
- Import only needed service clients to minimize bundle size.
- Reuse client objects (avoid recreating per request).
- Use `MessageGroupId` / dedup features if integrating with FIFO services.
- Externalize configuration (env vars or parameter store) not in code.
- Add structured JSON logs with context (requestId, region).
- Implement circuit breakers if calling high-latency operations.

---
