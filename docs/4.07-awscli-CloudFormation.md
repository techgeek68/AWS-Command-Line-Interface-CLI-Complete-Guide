# AWS CLI — CloudFormation Operations Guide

---
> Replace 123456789012 with your AWS Account ID, and adjust region (us-east-1) as needed.
---
> Sections cover validation, deployment, change sets, outputs, drift, stack policy, waiters, exports, stack sets, packaging, and troubleshooting.
---

## Table of Contents
1. [Overview](#overview)
2. [Quick Reference Variables](#quick-reference-variables)
3. [Template Validation](#template-validation)
4. [Deploy / Create / Update](#deploy--create--update)
5. [Change Sets](#change-sets)
6. [Stack Queries (Describe, Events, Resources)](#stack-queries-describe-events-resources)
7. [Outputs, Parameters, Exports](#outputs-parameters-exports)
8. [Waiters](#waiters)
9. [Drift Detection](#drift-detection)
10. [Stack Policies](#stack-policies)
11. [Termination & Deletion Protection](#termination--deletion-protection)
12. [Nested Stacks](#nested-stacks)
13. [Packaging (Artifacts & Lambda Code)](#packaging-artifacts--lambda-code)
14. [Stack Sets (Multi-Account / Multi-Region)](#stack-sets-multi-account--multi-region)
15. [Cost & Capability Flags](#cost--capability-flags)
16. [Automation Patterns & Scripting Snippets](#automation-patterns--scripting-snippets)
17. [Troubleshooting](#troubleshooting)
18. [Cleanup Sequences](#cleanup-sequences)
19. [Appendix: Example Stack Policy JSON](#appendix-example-stack-policy-json)
20. [Notes](#notes)
---

## Overview
CloudFormation (CFN) provides an infrastructure-as-code (IaC) engine to model, provision, and manage AWS resources.  
Typical flow: Validate → (Optional package) → Create/Deploy → Monitor events → Confirm completion → Export outputs (for chaining) → Detect drift → Update or Delete.

Two major CLI patterns:
- `create-stack` / `update-stack` (raw operations)
- `deploy` (higher-level convenience wrapper supporting parameter overrides, change sets implicitly, automatic create/update)

---

## Quick Reference Variables
You may export working vars to simplify commands:
```bash
export STACK_NAME=webapp-network
export TEMPLATE=templates/network.yaml
export CS_NAME=net-change-$(date +%Y%m%d%H%M%S)
export REGION=us-east-1
```

---

## Template Validation

### Validate template (local file)
Syntax:
```bash
aws cloudformation validate-template --template-body file://<TEMPLATE_FILE>
```
Example:
```bash
aws cloudformation validate-template --template-body file://templates/network.yaml
```

### Validate template (S3 URL)
Syntax:
```bash
aws cloudformation validate-template --template-url https://s3.amazonaws.com/<BUCKET>/<KEY>
```
Example:
```bash
aws cloudformation validate-template \
  --template-url https://s3.amazonaws.com/cfn-artifacts-dev/templates/app.yaml
```

### Extract parameters (names & defaults)
Example:
```bash
aws cloudformation validate-template \
  --template-body file://templates/app.yaml \
  --query 'Parameters[].{Name:ParameterKey,Default:DefaultValue}'
```

---

## Deploy / Create / Update

### Deploy (create-or-update convenience)
Syntax:
```bash
aws cloudformation deploy \
  --template-file <TEMPLATE_FILE> \
  --stack-name <STACK_NAME> \
  --capabilities <CAPS> \
  --parameter-overrides Key1=Value1 Key2=Value2 \
  [--tags Key=TagKey,Value=TagValue ...]
```
Example:
```bash
aws cloudformation deploy \
  --template-file templates/app.yaml \
  --stack-name webapp-app \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides Env=dev DesiredCapacity=2 ImageId=ami-0abcd1234ef567890 \
  --tags Project=WebApp Env=dev Owner=Platform
```

### Create stack (raw)
Syntax:
```bash
aws cloudformation create-stack \
  --stack-name <STACK_NAME> \
  --template-body file://<TEMPLATE_FILE> \
  --capabilities <CAPS> \
  --parameters ParameterKey=Key1,ParameterValue=Value1 ...
```
Example:
```bash
aws cloudformation create-stack \
  --stack-name webapp-network \
  --template-body file://templates/network.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameters ParameterKey=Env,ParameterValue=dev
```

### Update stack
Syntax:
```bash
aws cloudformation update-stack \
  --stack-name <STACK_NAME> \
  --template-body file://<TEMPLATE_FILE> \
  --capabilities <CAPS> \
  [--parameters ParameterKey=Key,ParameterValue=Value ...]
```
Example:
```bash
aws cloudformation update-stack \
  --stack-name webapp-app \
  --template-body file://templates/app.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameters ParameterKey=DesiredCapacity,ParameterValue=3
```
If no changes: output includes “No updates are to be performed.”

### Update using template from S3
Example:
```bash
aws cloudformation update-stack \
  --stack-name webapp-network \
  --template-url https://cfn-artifacts-dev.s3.amazonaws.com/templates/network-v2.yaml \
  --capabilities CAPABILITY_IAM
```

### Detect “no changes” safely (deploy)
Example:
```bash
aws cloudformation deploy \
  --template-file templates/app.yaml \
  --stack-name webapp-app \
  --no-fail-on-empty-changeset \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides DesiredCapacity=3 Env=dev
```

---

## Change Sets

### Create change set
Syntax:
```bash
aws cloudformation create-change-set \
  --stack-name <STACK_NAME> \
  --change-set-name <CHANGE_SET_NAME> \
  --template-body file://<TEMPLATE_FILE> \
  --capabilities <CAPS> \
  --parameters ParameterKey=Key,ParameterValue=Value ...
```
Example:
```bash
aws cloudformation create-change-set \
  --stack-name webapp-app \
  --change-set-name app-update-202508280935 \
  --template-body file://templates/app.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameters ParameterKey=DesiredCapacity,ParameterValue=4
```

### List change sets (for stack)
Example:
```bash
aws cloudformation list-change-sets --stack-name webapp-app \
  --query 'Summaries[].{Name:ChangeSetName,Status:Status,Exec:ExecutionStatus}'
```

### Describe change set
Syntax:
```bash
aws cloudformation describe-change-set \
  --stack-name <STACK_NAME> \
  --change-set-name <CHANGE_SET_NAME>
```
Example:
```bash
aws cloudformation describe-change-set \
  --stack-name webapp-app \
  --change-set-name app-update-202508280935 \
  --query 'Changes[].ResourceChange.{Action:Action,LogicalId:LogicalResourceId,Type:ResourceType,Replacement:Replacement}'
```

### Execute change set
Syntax:
```bash
aws cloudformation execute-change-set --stack-name <STACK_NAME> --change-set-name <CHANGE_SET_NAME>
```
Example:
```bash
aws cloudformation execute-change-set \
  --stack-name webapp-app \
  --change-set-name app-update-202508280935
```

### Delete an unused change set
Example:
```bash
aws cloudformation delete-change-set \
  --stack-name webapp-app \
  --change-set-name app-update-202508280935
```

---

## Stack Queries (Describe, Events, Resources)

### List stacks (filtered)
Syntax:
```bash
aws cloudformation list-stacks --stack-status-filter <STATUS1> <STATUS2>
```
Example:
```bash
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[].{Name:StackName,Status:StackStatus,Updated:LastUpdatedTime}'
```

### Describe stack
Syntax:
```bash
aws cloudformation describe-stacks --stack-name <STACK_NAME>
```
Example:
```bash
aws cloudformation describe-stacks --stack-name webapp-network \
  --query 'Stacks[0].{Name:StackName,Status:StackStatus,CreationTime:CreationTime}'
```

### Stack events (tail style)
Syntax:
```bash
aws cloudformation describe-stack-events --stack-name <STACK_NAME>
```
Example:
```bash
aws cloudformation describe-stack-events --stack-name webapp-app \
  --query 'StackEvents[0:10].[Timestamp,LogicalResourceId,ResourceStatus,ResourceStatusReason]'
```

### List resources
Syntax:
```bash
aws cloudformation list-stack-resources --stack-name <STACK_NAME>
```
Example:
```bash
aws cloudformation list-stack-resources --stack-name webapp-network \
  --query 'StackResourceSummaries[].{LogicalId:LogicalResourceId,Type:ResourceType,Status:ResourceStatus}'
```

### Filter failed resources
Example:
```bash
aws cloudformation list-stack-resources --stack-name webapp-app \
  --query 'StackResourceSummaries[?contains(ResourceStatus,`FAILED`)==`true`]'
```

---

## Outputs, Parameters, Exports

### Get stack outputs
Syntax:
```bash
aws cloudformation describe-stacks --stack-name <STACK_NAME> --query 'Stacks[0].Outputs'
```
Example:
```bash
aws cloudformation describe-stacks --stack-name webapp-network \
  --query 'Stacks[0].Outputs[].{Key:OutputKey,Value:OutputValue}'
```

### Export single output value (jq)
Example:
```bash
VPC_ID=$(aws cloudformation describe-stacks --stack-name webapp-network \
  --query "Stacks[0].Outputs[?OutputKey=='VpcId'].OutputValue" --output text)
echo $VPC_ID
```

### List all exports
Syntax:
```bash
aws cloudformation list-exports
```
Example (names only):
```bash
aws cloudformation list-exports --query 'Exports[].{Name:Name,Value:Value}'
```

### List parameters for a stack
Example:
```bash
aws cloudformation describe-stacks --stack-name webapp-app \
  --query 'Stacks[0].Parameters[].{Key:ParameterKey,Value:ParameterValue}'
```

---

## Waiters

### Wait for create complete
Syntax:
```bash
aws cloudformation wait stack-create-complete --stack-name <STACK_NAME>
```
Example:
```bash
aws cloudformation wait stack-create-complete --stack-name webapp-network
```

### Wait for update complete
Syntax:
```bash
aws cloudformation wait stack-update-complete --stack-name <STACK_NAME>
```
Example:
```bash
aws cloudformation wait stack-update-complete --stack-name webapp-app
```

### Combine create + outputs extraction
Example:
```bash
aws cloudformation create-stack \
  --stack-name webapp-network \
  --template-body file://templates/network.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameters ParameterKey=Env,ParameterValue=dev

aws cloudformation wait stack-create-complete --stack-name webapp-network

aws cloudformation describe-stacks --stack-name webapp-network \
  --query 'Stacks[0].Outputs'
```

---

## Drift Detection

### Start drift detection
Syntax:
```bash
aws cloudformation detect-stack-drift --stack-name <STACK_NAME>
```
Example:
```bash
DETECT_ID=$(aws cloudformation detect-stack-drift --stack-name webapp-network \
  --query 'StackDriftDetectionId' --output text)
echo $DETECT_ID
```

### Poll drift status
Syntax:
```bash
aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id <ID>
```
Example:
```bash
aws cloudformation describe-stack-drift-detection-status \
  --stack-drift-detection-id $DETECT_ID \
  --query '{Status:DetectionStatus,DriftStatus:StackDriftStatus}'
```

### Get drifted resources (after completion)
Example:
```bash
aws cloudformation describe-stack-resource-drifts \
  --stack-name webapp-network \
  --query 'StackResourceDrifts[?StackResourceDriftStatus==`MODIFIED`].[LogicalResourceId,ResourceType,StackResourceDriftStatus]'
```

---

## Stack Policies

### Apply stack policy
Syntax:
```bash
aws cloudformation set-stack-policy --stack-name <STACK_NAME> --stack-policy-body file://<POLICY_FILE>
```
Example:
```bash
aws cloudformation set-stack-policy \
  --stack-name webapp-app \
  --stack-policy-body file://policies/stack-policy.json
```

### Get existing stack policy
Example:
```bash
aws cloudformation get-stack-policy --stack-name webapp-app
```

---

## Termination & Deletion Protection

### Enable termination protection
Syntax:
```bash
aws cloudformation update-termination-protection --stack-name <STACK_NAME> --enable-termination-protection
```
Example:
```bash
aws cloudformation update-termination-protection \
  --stack-name webapp-network \
  --enable-termination-protection
```

### Disable termination protection
Example:
```bash
aws cloudformation update-termination-protection \
  --stack-name webapp-network \
  --no-enable-termination-protection
```

### Delete stack
Syntax:
```bash
aws cloudformation delete-stack --stack-name <STACK_NAME>
```
Example:
```bash
aws cloudformation delete-stack --stack-name webapp-app
```

### Wait for delete complete
Example:
```bash
aws cloudformation wait stack-delete-complete --stack-name webapp-app
```

---

## Nested Stacks
Provide parameters & exports for composition.

### Deploy a parent referencing child templates (via S3 URLs)
Example parent template parameter snippet (YAML):
```yaml
  NetworkTemplateUrl:
    Type: String
    Default: https://cfn-artifacts-dev.s3.amazonaws.com/templates/network.yaml
```

Create parent:
```bash
aws cloudformation create-stack \
  --stack-name webapp-parent \
  --template-body file://templates/parent.yaml \
  --capabilities CAPABILITY_NAMED_IAM
```

List nested:
```bash
aws cloudformation list-stack-resources --stack-name webapp-parent \
  --query 'StackResourceSummaries[?ResourceType==`AWS::CloudFormation::Stack`].[LogicalResourceId,PhysicalResourceId]'
```

---

## Packaging (Artifacts & Lambda Code)

### Package local templates (upload Lambda/Zips to S3)
Syntax:
```bash
aws cloudformation package --template-file <IN_TEMPLATE> --s3-bucket <BUCKET> --output-template-file <OUT_TEMPLATE>
```
Example:
```bash
aws cloudformation package \
  --template-file templates/app-lambda.yaml \
  --s3-bucket cfn-artifacts-dev \
  --output-template-file build/packaged-app-lambda.yaml
```

### Deploy packaged output
Example:
```bash
aws cloudformation deploy \
  --template-file build/packaged-app-lambda.yaml \
  --stack-name webapp-lambda \
  --capabilities CAPABILITY_IAM \
  --parameter-overrides Env=dev MemorySize=512
```

---

## Stack Sets (Multi-Account / Multi-Region)

### Create a stack set
Example:
```bash
aws cloudformation create-stack-set \
  --stack-set-name org-network-baseline \
  --template-body file://templates/network-baseline.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --permission-model SERVICE_MANAGED \
  --auto-deployment Enabled=true,RetainStacksOnAccountRemoval=false
```

### Create a stack set operation (deploy)
Example:
```bash
aws cloudformation create-stack-instances \
  --stack-set-name org-network-baseline \
  --deployment-targets OrganizationalUnitIds=ou-abcd-12345678 \
  --regions us-east-1 us-west-2
```

### List stack set operations
Example:
```bash
aws cloudformation list-stack-set-operations \
  --stack-set-name org-network-baseline \
  --query 'Summaries[].{Id:OperationId,Status:Status,Type:Action}'
```

### Describe specific operation
Example:
```bash
aws cloudformation describe-stack-set-operation \
  --stack-set-name org-network-baseline \
  --operation-id <OPERATION_ID> \
  --query 'StackSetOperation.{Status:Status,Action:Action,Creation:CreationTimestamp}'
```

---

## Cost & Capability Flags
Capabilities:
- `CAPABILITY_IAM` — acknowledges creation/modification of IAM resources.
- `CAPABILITY_NAMED_IAM` — for explicit named IAM resources.
- `CAPABILITY_AUTO_EXPAND` — automatically expands macros (e.g., SAM transform).

Example with macros:
```bash
aws cloudformation deploy \
  --template-file templates/sam-api.yaml \
  --stack-name webapp-api \
  --capabilities CAPABILITY_NAMED_IAM CAPABILITY_AUTO_EXPAND
```

---

## Automation Patterns & Scripting Snippets

### Create or update (idempotent script)
```bash
STACK=webapp-app
TEMPLATE=templates/app.yaml
PARAMS="Env=dev DesiredCapacity=2 ImageId=ami-0abcd1234ef567890"

aws cloudformation deploy \
  --stack-name $STACK \
  --template-file $TEMPLATE \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides $PARAMS \
  --tags Project=WebApp Env=dev
```

### Poll events until completion (lightweight)
```bash
STACK=webapp-app
until aws cloudformation describe-stacks --stack-name $STACK \
  --query "Stacks[0].StackStatus" --output text | grep -E '_(COMPLETE|FAILED)$'; do
  aws cloudformation describe-stack-events --stack-name $STACK \
    --query 'StackEvents[0].[Timestamp,LogicalResourceId,ResourceStatus]' --output text
  sleep 10
done
```

### Extract one output and feed into next deploy
```bash
VPC_ID=$(aws cloudformation describe-stacks --stack-name webapp-network \
  --query "Stacks[0].Outputs[?OutputKey=='VpcId'].OutputValue" --output text)

aws cloudformation deploy \
  --template-file templates/app.yaml \
  --stack-name webapp-app \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides Env=dev VpcId=$VPC_ID DesiredCapacity=2
```

---

## Troubleshooting
| Issue | Symptom | Cause | Resolution |
|-------|---------|-------|-----------|
| No updates are to be performed | update-stack shows message | Template identical or params unchanged | Confirm drift or required param change; use change set to inspect |
| UPDATE_ROLLBACK_FAILED | Cannot roll back | Blocking dependent resource / deletion fail | Fix underlying resource (e.g., detach ENI), then `continue-update-rollback` |
| ROLLBACK_COMPLETE | Deployment failed | Resource creation error | Inspect events for first FAILED event, correct template/params, redeploy |
| InsufficientCapabilitiesException | Error during create/update | Missing capabilities flag | Add `--capabilities CAPABILITY_IAM` or `CAPABILITY_NAMED_IAM` |
| Export already exists | create fails | Duplicate export name in another stack | Rename export or delete conflicting stack/export |
| Parameter validation failed | immediate failure | Missing required parameter or bad value | Validate `validate-template` output; ensure correct value format |
| AccessDenied (S3 template) | template-url invalid | Bucket policy denies CFN principal | Update S3 bucket policy to allow `cloudformation.amazonaws.com` read |
| Lambda zip not updated | code unchanged | Not packaged or versioned | Use `package`/`deploy` or include hash in S3 key; ensure new file uploaded |
| Drift detection timed out | drift job pending long | Many resources or service issues | Narrow resource scope (`describe-stack-resource-drifts`) or retry |
| DELETE_FAILED | stack stuck deleting | Dependent resource outside control | Manually remove or detach external dependency, retry delete |
| Change set EMPTY | no changes listed | Template logically identical | Confirm parameter differences; modify resource property to test |
| StackSet operation failed | partial regions success | IAM permission / OU scoping issue | Check operation status details; correct permission boundaries |

---

## Cleanup Sequences

### Delete all stacks with a project tag (careful)
```bash
aws cloudformation list-stacks \
  --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
  --query 'StackSummaries[].StackName' --output text | tr '\t' '\n' | while read S; do
  TAG_PRESENT=$(aws cloudformation describe-stacks --stack-name "$S" \
    --query "Stacks[0].Tags[?Key=='Project' && Value=='WebApp'] | length(@)")
  if [ "$TAG_PRESENT" -gt 0 ]; then
    echo "Deleting $S"
    aws cloudformation delete-stack --stack-name "$S"
  fi
done
```

### Delete a single stack (with waiter)
```bash
aws cloudformation delete-stack --stack-name webapp-app
aws cloudformation wait stack-delete-complete --stack-name webapp-app
```

### Remove stack set (after deleting instances)
```bash
aws cloudformation delete-stack-instances \
  --stack-set-name org-network-baseline \
  --deployment-targets OrganizationalUnitIds=ou-abcd-12345678 \
  --regions us-east-1 us-west-2 \
  --operation-preferences FailureTolerancePercentage=10 MaxConcurrentPercentage=50 \
  --no-retain-stacks

# Wait, then remove the stack set:
aws cloudformation delete-stack-set --stack-set-name org-network-baseline
```

---

## Appendix: Example Stack Policy JSON
File: `policies/stack-policy.json`
```json
{
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "Update:*",
      "Principal": "*",
      "Resource": "*"
    },
    {
      "Effect": "Deny",
      "Action": "Update:Delete",
      "Principal": "*",
      "Resource": "LogicalResourceId=CriticalKmsKey"
    }
  ]
}
```

---

## Notes
- Prefer `deploy` for simple pipelines; use explicit change sets for approval workflows.
- Keep templates modular (nested stacks or exported outputs).
- Use semantic versioning in S3 artifact keys to ensure change detection.
- Combine with `cfn-lint` (not AWS CLI) locally for static validation: `cfn-lint templates/app.yaml`.
- For large templates consider macros or CDK/SAM synthesis.
- Export naming guideline: `<Project>-<Env>-<OutputName>` to avoid conflicts.

---
