# AWS CLI v2 – Installation, Configuration, MFA & Troubleshooting


## Table of Contents
1. [Overview](#1-overview)
2. [Supported Platforms](#2-supported-platforms)
3. [Prerequisites](#3-prerequisites)
4. [Installation](#4-installation)
   - [Linux](#41-linux-ubuntu--debian--rhel--centos--amazon-linux)
   - [macOS](#42-macos)
   - [Windows](#43-windows)
5. [Post‑install Verification](#5-postinstall-verification)
6. [Configuration](#6-configuration)
   - [Default Profile](#61-interactive-default-profile)
   - [Credentials & Config Files](#62-credentials--config-file-examples)
   - [Named Profiles](#63-named-profiles)
   - [Environment Variables](#64-environment-variables-override-mechanism)
   - [Profiles vs Env Vars](#65-profiles-vs-environment-variables)
7. [MFA & Temporary Credentials (STS)](#7-mfa--temporary-credentials-sts)
   - [get-session-token](#71-get-session-token-stay-as-iam-user)
   - [assume-role](#72-assume-role-change-effective-identity)
   - [Comparison](#73-comparison)
8. [CLI Troubleshooting](#8-cli-troubleshooting-core-only)
9. [Best Practices](#9-best-practices-cli-scope)
10. [What’s Next](#whats-next)
11. [Placeholder Legend](#placeholder-legend)

---

## 1. Overview
The AWS CLI provides a unified, scriptable interface to AWS services. This guide covers only the core CLI lifecycle: install → configure → authenticate (including MFA / roles) → verify → troubleshoot.

Service task examples now live in:
- `docs/aws-ec2.md`
- `docs/aws-s3.md`
- `docs/aws-iam.md`
- `docs/aws-cloudformation.md`
- `docs/aws-lambda.md`
- `docs/aws-rds.md`
- `docs/aws-cloudwatch.md`

---

## 2. Supported Platforms
- Linux (x86_64, aarch64): Ubuntu/Debian, RHEL/CentOS, Amazon Linux
- macOS (Intel & Apple silicon)
- Windows 10 / 11 (PowerShell, Command Prompt)

---

## 3. Prerequisites
- AWS account IAM user, federated SSO, or role access
- Administrative or sudo rights for system installation
- `curl` and `unzip` (Linux/macOS manual install)
- (Optional) `jq` for parsing JSON in shell scripts
- A terminal (bash / zsh / PowerShell)

---

## 4. Installation

> Use only the section matching your OS.

════════════════════════════════════════ ════════════════════════════════════════

### 4.1 Linux (Ubuntu / Debian / RHEL / CentOS / Amazon Linux)

**Update packages:**

Debian / Ubuntu:
```bash
   sudo apt update && sudo apt upgrade -y
```

RHEL / CentOS / Amazon Linux:
```bash
   sudo yum update -y
```

**Install prerequisites:**
```bash
#Debian/Ubuntu
   sudo apt install -y curl unzip
```
```bash
#RHEL/CentOS/Amazon Linux
   sudo yum install -y curl unzip
```

**Determine architecture:**
```bash
   uname -m
```
Common outputs: `x86_64, aarch64`

**Download (choose the correct architecture):**

**x86_64**
```bash
   curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
```

**ARM (aarch64)**
```bash
   curl "https://awscli.amazonaws.com/awscli-exe-linux-aarch64.zip" -o "awscliv2.zip"
```

**Unzip & install:**
```bash
   unzip awscliv2.zip
```
```bash
   sudo ./aws/install
```
-----
**Custom install location:**
Following the installation, AWS CLI v2 is installed into /usr/local/aws-cli and made globally accessible by creating a shortcut in /usr/local/bin.
```bash
   sudo ./aws/install -i /usr/local/aws-cli -b /usr/local/bin
```

**Verify:**
```bash
   aws --version
```

**Uninstall:**
```bash
   sudo rm -rf /usr/local/aws-cli
```
```bash
   sudo rm /usr/local/bin/aws 2>/dev/null || true
```
---
════════════════════════════════════════ ════════════════════════════════════════ 

### 4.2 macOS

**Method A – Homebrew (preferred for updates):**
```bash
   brew update
```
```bash
   brew install awscli
```
```bash
   aws --version
```
---
**Upgrade later:**
```bash
   brew upgrade awscli
```
---
**Method B – Official pkg**
1. Download `AWSCLIV2.pkg` from AWS.
2. Double‑click & follow the installer.
3. Verify:
    ```bash
       aws --version
    ```
4. Uninstall:
    ```bash
       sudo rm -rf /usr/local/aws-cli
   ```
   ```bash
       sudo rm /usr/local/bin/aws 2>/dev/null || true
    ```
---

════════════════════════════════════════ ════════════════════════════════════════
### 4.3 Windows
---
**Method A – MSI Installer:**
```powershell
   msiexec.exe /i https://awscli.amazonaws.com/AWSCLIV2.msi
```
_Run as Administrator. Finish wizard._

**Verify (PowerShell):**
```powershell
   aws.exe --version
```

---

**Method B – winget:**
```powershell
   winget source update
```
```powershell
   winget install Amazon.AWSCLI
```
```powershell
   aws.exe --version
```

---
If `aws` is not recognized:
- Close all terminal/PowerShell windows.
- Locate the AWS CLI path (default for v2): C:\Program Files\Amazon\AWSCLIV2\bin\
- Open System Properties:  
- Press **Win + R**, type `sysdm.cpl`, press **Enter**.
   - **Go to Environment Variables**:  
   - In **Advanced** tab → click **Environment Variables…**
   - **Edit PATH variable**:  
   - Under **System variables** (or **User variables** if only for you), select **Path** → click **Edit**.  
   - Click **New** → paste:  
     ```
        C:\Program Files\Amazon\AWSCLIV2\bin\
     ```
   - **Save**: Click **OK** on all dialogs.
   - **Restart terminal/PowerShell** (changes won’t apply to already open shells).
     
---
**Uninstall:** 
```powershell
   winget uninstall Amazon.AWSCLI
```
Or via Control Panel (for MSI).

---
## 5. Post‑install Verification

Linux/Unix:
```bash
   aws --version
```
```bash
   aws sts get-caller-identity                        #will fail if not configured
```
```bash
   aws ec2 describe-regions --output table
```
---

PowerShell alternative:

```powershell
   aws.exe sts get-caller-identity
```

```powershell
   aws.exe ec2 describe-regions --output table
```
---
════════════════════════════════════════ ════════════════════════════════════════
## 6. Configuration

AWS CLI stores:
- Credentials: `~/.aws/credentials` (Linux/macOS) or `%UserProfile%\.aws\credentials` (Windows)
- Config: `~/.aws/config` (Linux/macOS) or `%UserProfile%\.aws\config` (Windows)

---
### 6.1 Interactive Default Profile

Linux/Unix:
```bash
   aws configure
```

PowerShell:
```powershell
   aws.exe configure
```
Prompts:
- AWS Access Key ID:
- AWS Secret Access Key:
- Default region (e.g., us-east-1):
- Default output (`json`, `yaml`, `text`, `table`):

If your key starts with `ASIA`, you have temporary STS credentials; you must also supply a Session Token manually.

Add session token after configuration:

**Linux/macOS**
```bash
   vi ~/.aws/credentials
```

**Windows**
```bash
   notepad $env:UserProfile\.aws\credentials
```
         Add:`aws_session_token = <SESSION_TOKEN>`

Verify:

```powershell
   aws.exe sts get-caller-identity
```
---
### 6.2 Examples: Credentials & Config File

Linux/Unix:
            `vim ~/.aws/credentials`
Windows:
            `notepad $env:UserProfile\.aws\credentials`

```ini
   [default]
   aws_access_key_id = AKIA_DEFAULT...
   aws_secret_access_key = defaultSecret...

   [prod]
   aws_access_key_id = AKIA_PROD...
   aws_secret_access_key = prodSecret...
```

```ini
   [default]
   region = us-east-1
   output = json

   [profile prod]
   region = us-west-2
   output = json
```

---
### 6.3 Named Profiles
Use --profile prod to run a single AWS CLI command with the prod profile, or set.

Create:
```bash
   aws configure --profile prod
```
Uses:
```bash
   aws s3 ls --profile prod
```

Set the default for the whole shell session so exporting makes all commands in the current shell session use prod by default. 
Linux/Unix:
```bash
   export AWS_PROFILE=prod           #bash/zsh
```

PowerShell:
```powershell
   $Env:AWS_PROFILE = 'prod'
```

---
### 6.4 Environment Variables (Override Mechanism):
   Environment variables let you override AWS CLI profile settings without editing ~/.aws/credentials or using --profile. They take the highest precedence over profiles.

Bash:
```bash
   export AWS_ACCESS_KEY_ID="AKIA..."
   export AWS_SECRET_ACCESS_KEY="..."
   export AWS_SESSION_TOKEN="..."        # only for temporary creds
   export AWS_DEFAULT_REGION="us-east-1"
```

PowerShell:
```powershell
   $Env:AWS_ACCESS_KEY_ID="AKIA..."
   $Env:AWS_SECRET_ACCESS_KEY="..."
   $Env:AWS_SESSION_TOKEN="..."
   $Env:AWS_DEFAULT_REGION="us-east-1"
```

Unset:

Linux/Unix:
```bash
   unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_PROFILE
```
PowerShell:
```powershell
"ACCESS_KEY_ID","SECRET_ACCESS_KEY","SESSION_TOKEN","PROFILE","DEFAULT_REGION" | ForEach-Object { Remove-Item Env:AWS_$_ -ErrorAction SilentlyContinue }
```

---
### 6.5 Profiles vs Environment Variables
| Aspect         | Profiles          | Environment Variables      |
|----------------|------------------|---------------------------|
| Persistence    | Stored on disk    | Temporary (session scope) |
| Use Case       | Daily dev contexts| CI/CD, ephemeral sessions |
| Priority       | Lower (overridden)| Higher (overrides profiles)|
| Security Rotation| Manual edit    | Easy to rotate frequently |

_Recommendation: Use profiles for stable contexts, env vars for automation / temporary STS sessions._

════════════════════════════════════════ ════════════════════════════════════════

## 7. MFA & Temporary Credentials (STS)

### 7.1 get-session-token (Stay as IAM User)
Used when your IAM policies require MFA but you do not need to change roles.

Request:
```bash
aws sts get-session-token \
  --serial-number arn:aws:iam::123456789012:mfa/your-username \
  --token-code 123456 \
  --duration-seconds 3600
```

Response (truncated):
```json
{
  "Credentials": {
    "AccessKeyId": "ASIA....",
    "SecretAccessKey": "abcd...",
    "SessionToken": "IQoJb3...",
    "Expiration": "2025-08-17T12:34:56Z"
  }
}
```

Export (bash):
```bash
export AWS_ACCESS_KEY_ID="ASIA..."
export AWS_SECRET_ACCESS_KEY="abcd..."
export AWS_SESSION_TOKEN="IQoJb3..."
```

Save to profile:
```bash
aws configure set aws_access_key_id "ASIA..."     --profile mfa
aws configure set aws_secret_access_key "abcd..." --profile mfa
aws configure set aws_session_token "IQoJb3..."   --profile mfa
```
Use:
```bash
aws s3 ls --profile mfa
```
---
### 7.2 assume-role (Change Effective Identity)
Common for cross-account access, privilege escalation with MFA, or separating duties.

```bash
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/AdminRole \
  --role-session-name mySession \
  --serial-number arn:aws:iam::123456789012:mfa/your-username \
  --token-code 123456
```

Extract & export (bash):
```bash
CREDS_JSON=$(aws sts assume-role ... )
export AWS_ACCESS_KEY_ID=$(echo "$CREDS_JSON" | jq -r '.Credentials.AccessKeyId')
export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS_JSON" | jq -r '.Credentials.SecretAccessKey')
export AWS_SESSION_TOKEN=$(echo "$CREDS_JSON" | jq -r '.Credentials.SessionToken')
```

PowerShell example:
```powershell
$creds = aws sts assume-role --role-arn arn:aws:iam::123456789012:role/AdminRole --role-session-name mySession
$ak = ($creds | ConvertFrom-Json).Credentials.AccessKeyId
$sk = ($creds | ConvertFrom-Json).Credentials.SecretAccessKey
$st = ($creds | ConvertFrom-Json).Credentials.SessionToken
$Env:AWS_ACCESS_KEY_ID  = $ak
$Env:AWS_SECRET_ACCESS_KEY = $sk
$Env:AWS_SESSION_TOKEN = $st
```
---
### 7.3 Comparison

| Feature          | get-session-token    | assume-role           |
|------------------|---------------------|-----------------------|
| Identity         | Same IAM user       | Role (different principal) |
| Permissions      | Same as user        | Role policy set       |
| Typical Use      | Add MFA to user     | Cross-account / elevated rights |
| Max Duration     | Up to 36h (user policy dependent) | Up to 12h (role setting) |
| MFA              | At call if required | In trust policy / enforced  |
| ExternalId       | N/A                 | Supported             |

---
════════════════════════════════════════   ════════════════════════════════════════

## 8. CLI Troubleshooting (Basic Only)

| Symptom                          | Cause                    | Resolution                                                         |
|-----------------------------------|--------------------------|--------------------------------------------------------------------|
| `aws: command not found`          | PATH missing             | Reinstall or add install `bin` to PATH                             |
| `'aws' is not recognized` (Win)   | PATH not refreshed       | Reopen terminal / add `C:\Program Files\Amazon\AWSCLIV2\bin`       |
| `AccessDenied`                    | Missing permissions      | Check active credentials (`aws sts get-caller-identity`)           |
| Invalid MFA token                 | Clock drift / wrong device| Verify device time & ARN                                           |
| `Could not connect to the endpoint URL` | Wrong region / network / proxy | Confirm region flag or set `AWS_DEFAULT_REGION`            |
| SSL errors                        | Corporate MITM / missing CA bundle | Configure `AWS_CA_BUNDLE` or trust corporate CA          |
| Wrong profile used                | Env var precedence       | `unset AWS_PROFILE` or inspect with `env | grep AWS`               |
| `ExpiredToken`                    | STS creds expired        | Re-run `get-session-token` / `assume-role`                         |

Inspect current identity:
```bash
   aws sts get-caller-identity
```
List files:
```bash
   cat ~/.aws/credentials
```
```bash
   cat ~/.aws/config
```

════════════════════════════════════════  ════════════════════════════════════════  

## 9. Best Practices (CLI Scope)
- Prefer **roles + MFA** over long‑lived user keys.
- Keep least privilege: separate read-only, dev, prod profiles.
- Avoid checking credentials into scripts; inject via environment/secrets manager in CI.
- Rotate access keys regularly; remove unused ones.
- Use `--profile` explicitly in automation to reduce ambiguity.
- Validate commands with `--dry-run` (services that support it, e.g., EC2).
- Leverage `--output yaml` or `--query` for clean structured automation.
- Use `aws configure sso` for AWS IAM Identity Center (SSO) if available.

════════════════════════════════════════  ════════════════════════════════════════  

## 10. What’s Next
See service guides in chapter `04.4.xx` for task-focused examples (EC2, S3, IAM, etc.).

════════════════════════════════════════  ════════════════════════════════════════ 

## 11. Placeholder Legend
Common semantic placeholders used across service guides:

| Placeholder | Meaning |
|-------------|---------|
| <ACCOUNT_ID> | 12-digit AWS account number |
| <REGION> | AWS region (e.g. us-east-1) |
| <PROFILE_NAME> | Named CLI profile |
| <ACCESS_KEY_ID>/<SECRET_ACCESS_KEY>/<SESSION_TOKEN> | Long-lived or temporary credentials |
| <KEY_PAIR_NAME>/<KEY_FILE> | EC2 key pair name & local private key file |
| <VPC_ID>/<SUBNET_ID>/<SECURITY_GROUP_ID> | Networking resource identifiers |
| <SECURITY_GROUP_NAME> | Name when creating a security group |
| <AMI_ID> | Amazon Machine Image ID |
| <INSTANCE_ID> | EC2 instance ID |
| <TAG_VALUE> | Value for a resource tag (e.g., Name) |
| <BUCKET_NAME>/<OBJECT_KEY>/<PREFIX> | S3 bucket name, object key, or key prefix |
| <LOCAL_FILE>/<LOCAL_DIR> | Local filesystem path(s) |
| <KMS_KEY_ID> | KMS key alias or ARN/ID |
| <USER_NAME>/<GROUP_NAME>/<ROLE_NAME>/<ROLE_ARN> | IAM principal identifiers |
| <POLICY_NAME>/<POLICY_ARN> | IAM policy identifiers |
| <PRINCIPAL_ARN> | IAM principal ARN for simulations |
| <STACK_NAME>/<CHANGE_SET_NAME>/<DRIFT_DETECTION_ID> | CloudFormation identifiers |
| <PARAM_KEY>/<PARAM_VALUE> | Template parameter key/value |
| <FUNCTION_NAME>/<ALIAS_NAME>/<VERSION> | Lambda function metadata |
| <EVENT_FILE> | Local event JSON for Lambda invoke |
| <LOG_GROUP_NAME>/<LOG_STREAM_NAME> | CloudWatch Logs identifiers |
| <ALARM_NAME> | CloudWatch alarm name |
| <SERVICE_DIMENSION> | Dimension value for a custom metric |
| <QUERY_ID> | CloudWatch Logs Insights query id |
| <DB_IDENTIFIER>/<SNAPSHOT_ID>/<ENGINE_VERSION> | RDS identifiers |
| <PARAMETER_GROUP_NAME> | RDS parameter group name |
| <REPOSITORY_NAME>/<IMAGE_TAG> | ECR repository & image tag |
| <CLUSTER_NAME>/<NODEGROUP_NAME> | EKS cluster & node group names |
| <PARAMETER_NAME>/<PARAMETER_VALUE> | SSM Parameter Store name/value |
| <TABLE_NAME>/<PARTITION_KEY>/<SORT_KEY> | DynamoDB components |
| <TOPIC_ARN>/<QUEUE_URL>/<QUEUE_NAME> | SNS topic ARN / SQS queue URL/name |

════════════════════════════════════════  ════════════════════════════════════════  
