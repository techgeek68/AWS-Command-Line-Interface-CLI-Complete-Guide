# AWS CloudShell — Operations & Productivity Guide

---
> Replace sample Account IDs (123456789012), regions (us-east-1), ARNs, resource names, and emails with your own.
---

## Table of Contents
1. Overview  
2. Quick Reference Environment  
3. Launching & Session Lifecycle  
4. Authentication & IAM Context  
5. Regions & Multi-Region Workflow  
6. Persistent Storage & File Management  
7. Package & Dependency Management (pip, yum, node)  
8. Environment Customization (Profiles, Init, Aliases, Prompt)  
9. Working with AWS CLI (Syntax + Examples)  
10. Scripting & Automation Patterns  
11. SDK (Python boto3) Usage  
12. Git & Source Control in CloudShell  
13. Interacting with S3 (Upload / Download / Sync)  
14. Working with Other AWS Services (EC2, SSM, Lambda, CloudFormation)  
15. Security Practices & Least Privilege  
16. Performance & Limits  
17. Troubleshooting  
18. Cleanup & Storage Reclamation  
19. Best Practices Recap   
20. Notes & References  

---

## 1. Overview
AWS CloudShell is a browser-based, pre-authenticated shell environment (Amazon Linux 2 variant) within the AWS Management Console.

Key characteristics:
- Auth inherits your console session / SSO / federation — NO credential file needed by default.
- Persistent 1 GB home directory per region (`/home/cloudshell-user/`).
- Pre-installed tools: AWS CLI v2, Python3, pip, Node.js & npm (often), git, jq, curl, unzip/zip, tar, less, nano/vi.
- Ephemeral OS layer: System-level packages installed via `sudo yum` vanish after environment refresh (files in `$HOME` persist).
- Ideal for: Quick experiments, troubleshooting, devops demos, parameter/script editing, small automation tasks.

---

## 2. Quick Reference Environment

Show versions
```bash
  aws --version
```
```bash
  python3 --version
```
```bash
  node --version 2>/dev/null || echo "Node not present"
```
```bash
  jq --version
```

# Paths & identity

```
  echo $HOME                #/home/cloudshell-user
```
```
  pwd
```
```
  whoami              #cloudshell-user
```
  

# Disable CLI pager (less)
By default, AWS CLI sometimes pipes long outputs through a pager (like less) so you can scroll through results. Setting
    `export AWS_PAGER=""`
disables the pager, so all AWS CLI output is printed directly to your terminal instead of opening inside less.

# Environmental Variable (Fast variables)
These "fast variables" save time because you don’t have to manually type your region, account ID, or timestamp over and over again.
Examples:
```
export REGION=us-east-1
```
  `
  aws ec2 describe-instances --region $REGION
  `
```
export ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
```
```
export DATE=$(date -u +%Y%m%dT%H%M%SZ)
```


# Confirm identity:

Run the command below to confirm your identity:
```
  aws sts get-caller-identity
```

Example output (identity):
```json
{
  "UserId": "AIDAEXAMPLE123456789",
  "Account": "123456789012",
  "Arn": "arn:aws:iam::123456789012:user/dev-user"
}
```
---

## 3. Launching & Session Lifecycle
CloudShell sessions are created per-region.
* **Region-specific:** Each region has its **own isolated `$HOME`**.
* **Idle timeout:** Session closes after inactivity; running processes stop.
* **Persistence:**
  * `$HOME` → persists across sessions.
  * `/tmp` & system-level context → reset on new session.
* **Switching regions:** Each region has a separate `$HOME`.
* **Example flow:**
  1. Open CloudShell → terminal in default region.
  2. Run commands (e.g., `aws ec2 describe-regions`).
  3. Idle → session closes automatically.
  4. Reopen → `$HOME` files remain; `/tmp` resets.
---
Example flow:
1. Open AWS Console → Click CloudShell icon → Terminal starts in your default region.
2. Run a quick command:
   ```bash
     aws ec2 describe-regions --query 'Regions[0].RegionName'
   ```
3. Leave idle until timed out → Reopen CloudShell → previous files remain:
   ```bash
     ls ~
   ```
---

## 4. Authentication & IAM Context

### Current identity
Syntax:
```bash
  aws sts get-caller-identity --query <JQ-like-query> --output <output-format>
```
Examples:
```bash
  aws sts get-caller-identity --query 'Account'
```
```bash
  aws sts get-caller-identity --query 'UserId'
```

### Assume a cross-account role
Use `aws sts assume-role` to temporarily assume a role in another AWS account. The command returns temporary credentials (AccessKey, SecretKey, SessionToken), which you export as environment variables to run AWS CLI commands using that role.

Syntax:
```bash
aws sts assume-role --role-arn <ROLE_ARN> --role-session-name <SESSION_NAME>
```

Example:
```bash
aws sts assume-role \
  --role-arn arn:aws:iam::222233334444:role/CrossAccountRead \
  --role-session-name cloudShellXAcct \
  > /tmp/assume.json

export AWS_ACCESS_KEY_ID=$(jq -r '.Credentials.AccessKeyId' /tmp/assume.json)
export AWS_SECRET_ACCESS_KEY=$(jq -r '.Credentials.SecretAccessKey' /tmp/assume.json)
export AWS_SESSION_TOKEN=$(jq -r '.Credentials.SessionToken' /tmp/assume.json)
```

### Return to original console credentials
```bash
  unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
```

### List active environment AWS_* vars
Use this command to see all currently set AWS-related environment variables:
```bash
  env | grep '^AWS'
```
---

## 5. Regions & Multi-Region Workflow

### List EC2 regions
```bash
  aws ec2 describe-regions --query 'Regions[].RegionName' --output text | tr '\t' '\n'
```

### One-off region override
Overrides the default region for this single command without changing global configuration. Useful for quickly accessing resources in another region.
Example:
```bash
  aws s3 ls --region us-west-1                      #No permission for Academy License & Free Tier
```

### Loop multi-region availability zones
You can loop through multiple AWS regions to list their availability zones. For each region, print the region name as a header, then use `aws ec2 describe-availability-zones` to retrieve and display all zone names. This helps quickly see which AZs exist in each region.
Example:
```bash
for R in us-east-1 eu-west-1 ap-southeast-1; do
  echo "=== $R ==="
  aws ec2 describe-availability-zones --region "$R" \
    --query 'AvailabilityZones[].ZoneName'
done
```

### Parallel (simple) region test (careful with concurrency)
This command runs AWS CLI calls in parallel for multiple regions:
```bash
printf "us-east-1\neu-west-1\nap-southeast-1\n" | \
xargs -n1 -P3 -I{} bash -c 'echo {}; aws sts get-caller-identity --region {} --query Account --output text'
```
Use Case: Quickly verify AWS access or credentials across multiple regions.
Caution: Running too many parallel commands may hit API rate limits.

---

## 6. Persistent Storage & File Management

### Create script (syntax & example)
Syntax:
```bash
  echo '<COMMANDS>' > ~/script.sh && chmod +x ~/script.sh
```
Example:
```bash
  echo 'aws ec2 describe-instances --query "Reservations[].Instances[].InstanceId"' > ~/list-ec2.sh
```
```bash
  ls -lh
```
```bash
  chmod +x ~/list-ec2.sh
```
```bash
  ./list-ec2.sh
```

### Find largest files
```bash
  find ~ -type f -printf '%s %p\n' 2>/dev/null | sort -nr | head -15
```
  * `find ~ -type f` → searches for all files under your home directory.
  * `-printf '%s %p\n'` → prints file size in bytes followed by the file path.
  * `2>/dev/null` → hides permission errors.
  * `sort -nr` → sorts the results numerically in **descending order** (largest first).
  * `head -15` → shows the **top 15 largest files**.

### Disk usage summary
```bash
  du -sh ~/* 2>/dev/null | sort -hr | head
```
  * `du -sh ~/*` → shows the **size of each file and folder** in your home directory in a human-readable format.
  * `2>/dev/null` → hides permission errors.
  * `sort -hr` → sorts the sizes **in descending order** (largest first).
  * `head` → displays the **top entries**, helping you quickly identify which directories or files use the most space.

### Archive and upload to S3
Archiving:
```bash
  tar czf "$DATE-home.tgz" ~/*
```
Uploading to S3:
```bash
  aws s3 cp "$DATE-home.tgz" s3://my-cloudshell-backups/
```

### Recent changes in files
```bash
  find ~ -type f -mtime -1 -maxdepth 4 -print
```
  * `find ~ -type f` → searches for all files under your home directory.
  * `-mtime -1` → filters files **modified in the last 1 day**.
  * `-maxdepth 4` → limits the search to **4 directory levels deep**.
  * `-print` → displays the paths of the matching files.


---

## 7. Package & Dependency Management (pip, yum, node)

### Install OS package (ephemeral)
```bash
  sudo yum install -y tree
```
```bash
  tree -L 1 ~
```
  * `tree` → displays the directory structure as a tree.
  * `-L 1` → limits the display to **one level deep** (top-level folders and files only).
  * `~` → specifies your home directory.
    
(Will vanish on environment refresh.)

### Python user packages (persist)
You can install Python packages for AWS scripting and CLI helpers using `pip3` with the `--user` flag, which installs them just for your account. The main packages are `boto3` (AWS SDK), `rich` (for formatted console output), and `typer` (for building CLI apps). After installation, you can verify by importing the packages in Python and checking the `boto3` version.
Install:
```bash
  pip3 install --user boto3 rich typer
```
Verify Installation:
```bash
  python3 -c "import boto3, rich; print(boto3.__version__)"
```

### Show installed user packages
Quickly check which Python packages are installed without listing the entire system-wide environment.
```bash
  python3 -m pip list --user | head
```

### Virtual environment
Isolate project dependencies to avoid conflicts with system-wide Python packages.
  * `python3 -m venv ~/venvs/tools` → creates a **virtual environment** in `~/venvs/tools`.
  * `source ~/venvs/tools/bin/activate` → activates the virtual environment; Python and pip now use this isolated environment.
  * `pip install requests` → installs packages **only inside the virtual environment**.
  * `deactivate` → exits the virtual environment, returning to the system Python.
Example:
```bash
  python3 -m venv ~/venvs/tools
```
```bash
  source ~/venvs/tools/bin/activate
```
```bash
  pip install requests
```
```bash
  deactivate
```

### Node packages (if Node present)
Quickly set up Node projects and manage packages locally without affecting the global Node environment.

Create a package.json with default settings:
```bash
  npm init -y
```
Installs axios (HTTP client) in the project folder:
```bash
  npm install axios
```
Imports axios in Node and prints its version:
```bash
  node -e "console.log(require('axios').version)"
```
```bash
  npm list axios
```
---

## 8. Environment Customization (Profiles, Init, Variables, Prompt)

### Persistent aliases & exports
```bash
  cat >> ~/.bashrc <<'EOF'
  export AWS_DEFAULT_REGION=us-east-1
  export AWS_PAGER=""
  alias ll='ls -alF'
  alias ec2ids='aws ec2 describe-instances --query "Reservations[].Instances[].InstanceId" --output text'
  EOF
```
```bash
  source ~/.bashrc
```
```bash
  cat ./.bashrc
```

### Custom prompt (adds region & account)
```bash
  cat >> ~/.bashrc <<'EOF'
  prompt_account() { aws sts get-caller-identity --query Account --output text 2>/dev/null; }
  export PS1='[\u@\h \W $(prompt_account):$(aws configure get region 2>/dev/null)]$ '
  EOF
```
```bash
  source ~/.bashrc
```

### AWS CLI profiles (`~/.aws/config`)
```ini
[profile base]
region = us-east-1

[profile prod-admin]
role_arn = arn:aws:iam::999988887777:role/Admin
source_profile = base
region = us-east-1
```
Use:
```bash
aws sts get-caller-identity --profile prod-admin --query Arn
```

### Disable auto CLI prompt (if enabled)
```bash
aws configure set cli_auto_prompt off
```

---

## 9. Working with AWS CLI (Syntax + Examples)

### Generic syntax
```bash
aws <service> <operation> [--parameters ...] [--query '<JMESPath>'] [--output json|table|text]
```

### Examples
```bash
  aws iam list-users --output table
```
```bash
  aws lambda list-functions --region us-east-1 --query 'Functions[].FunctionName'
```
```bash
  aws ec2 describe-instances \
    --query 'Reservations[].Instances[].{Id:InstanceId,State:State.Name,Type:InstanceType}' \
    --output table
```

### Store JSON output to a file
The AWS CLI (aws) to call the S3 API (s3api) and list all S3 buckets in your account.
```bash
  aws s3api list-buckets > buckets.json
```
It prints the first 10 S3 bucket names from buckets.json, each as a quoted JSON string.
```bash
 jq '.Buckets[].Name' buckets.json | head
```

### Dry-run pattern (EC2)
The “dry-run” means a test or simulation: the command checks if it would work (e.g., permissions, instance state) without actually acting.

The following command performs a dry run of starting the EC2 instance with ID i-0123456789abcdef0, meaning it checks whether you have permission and if the action would succeed without actually starting the instance.
```bash
aws ec2 start-instances --instance-ids i-0123456789abcdef0 --dry-run
```

---

## 10. Scripting & Automation Patterns
It emphasizes reusable scripting patterns, such as loops, filters, and dry-run checks, to efficiently manage cloud resources, minimize manual intervention, and maintain consistent operations across EC2, S3, and other AWS services.

### Loop processing instances
This loop lists all EC2 instances tagged Env=dev and prints each instance ID along with its current state.
```bash
for ID in $(aws ec2 describe-instances \
  --filters "Name=tag:Env,Values=dev" \
  --query 'Reservations[].Instances[].InstanceId' --output text); do
  echo "Instance: $ID"
  aws ec2 describe-instance-status --instance-ids "$ID" \
    --query 'InstanceStatuses[].InstanceState.Name'
done
```

### Conditional resource creation
This script checks if the S3 bucket my-app-artifacts exists and creates it if it doesn’t, otherwise it reports that the bucket already exists.
```bash
if ! aws s3api head-bucket --bucket my-app-techgeek68 2>/dev/null; then
  aws s3 mb s3://my-app-techgeek68 --region us-east-1
  echo "Bucket created."
else
  echo "Bucket exists."
fi
```

List:
```bash
  aws s3api list-buckets --query "Buckets[].Name"
```

### Parallel describe (limit concurrency)
Describe multiple EC2 instances in parallel with limited concurrency:
```bash
aws ec2 describe-instances --query 'Reservations[].Instances[].InstanceId' --output text | \
tr '\t' '\n' | head -5 | xargs -P3 -n1 -I{} aws ec2 describe-instance-attribute --instance-id {} --attribute instanceType
```

### Execution timer
A simple Bash execution timer. It measures how long a command or series of commands takes to run.
```bash
  START=$(date +%s)
      #your commands here
  END=$(date +%s); echo "Elapsed: $((END-START)) seconds"
```
Example:
- Let’s time a loop that counts numbers from 1 to 1,000,000:
```bash
START=$(date +%s%3N)

for i in {1..1000000}; do
  : 
done

END=$(date +%s%3N)
echo "Elapsed: $((END-START)) milliseconds"
```

---

## 11. SDK (Python boto3) Usage

### Check identity
A quick Python one-liner to check your AWS identity using the AWS SDK (boto3).
```bash
  python3 -c "import boto3, json; print(json.dumps(boto3.client('sts').get_caller_identity(), indent=2))"
```

### Script example
That script lists all AWS Lambda function names in your account using boto3.
Create a file:
```bash
vi list_lambda.py
```
```python
import boto3
lam = boto3.client('lambda')
for f in lam.list_functions()['Functions']:
    print(f['FunctionName'])
```
Run:
```bash
python3 ~/list_lambda.py
```

### Pagination sample
Python script using the AWS SDK (boto3) to list objects in an S3 bucket.
```bash
vi list_objects.py
```
```python
import boto3
s3 = boto3.client('s3')
p = s3.get_paginator('list_objects_v2')
for page in p.paginate(Bucket='my-logs-bucket', Prefix='2025/'):
    for obj in page.get('Contents', []):
        print(obj['Key'])
```
Run:
```bash
python3 ~/list_objects
```
---

## 12. Git & Source Control in CloudShell

### Configure user
```bash
  git config --global user.name "Alice Example"
```
```bash
  git config --global user.email "alice@example.com"
```
Verify
```bash
  git config --global --list
```

### Clone & inspect
```bash
  git clone git@github.com:techgeek68/aws-access-methods-guide.git
```
```bash
  cd aws-access-methods-guide
```
```bash
  git log --oneline | head            #That command shows the latest commits in your repository in a compact format.
```

### Create commit
```bash
  echo "Notes $(date)" >> LOCAL_NOTES.md
```
```bash
  git add LOCAL_NOTES.md
```
```bash
  git commit -m "Add local notes"
```

### Push (requires PAT/federation authorized)
```bash
  git push origin main
```

### Store token in environment temporarily (avoid committing)
```bash
  export GITHUB_TOKEN=ghp_xxx
```

---

## 13. Interacting with S3 (Upload / Download / Sync)

### Upload file
```bash
  echo "hello $(date)" > note.txt
```
```bash
  aws s3 cp note.txt s3://my-bucket/
```

### Download object
```bash
  aws s3 cp s3://my-bucket/note.txt note-downloaded.txt
```

### Sync directory
```bash
  aws s3 sync ~/scripts/ s3://my-bucket/scripts-backup/
```

### List filtered keys
Lists objects in an S3 bucket under a specific prefix, showing only their key names and sizes.
```bash
  aws s3api list-objects-v2 --bucket my-bucket --prefix logs/2025/04/ \
    --query 'Contents[].{Key:Key,Size:Size}' | head
```

### Pre-signed URL
Generates a temporary URL to access an S3 object without requiring AWS credentials.
```bash
  aws s3 presign s3://my-bucket/note.txt --expires-in 3600
```
---

## 14. Working with Other AWS Services

### EC2 start/stop
```bash
  aws ec2 start-instances --instance-ids i-0123456789abcdef0
```
```bash
  aws ec2 stop-instances --instance-ids i-0123456789abcdef0
```

### Lambda invoke
Manually invoke a Lambda function and then view its response.
The following snippet is invoking a Lambda function and saving its output.
  - Lambda invoke: Runs the Lambda function my-func with the JSON payload {"action":"ping"} and writes the response to out.json.
  - cat out.json: Displays the Lambda function’s response that was written to the file.
    
```bash
aws lambda invoke \
  --function-name my-func \
  --payload '{"action":"ping"}' \
  out.json
```
```bash
  cat out.json
```

### CloudFormation deploy
The following example creates or updates a CloudFormation stack (net-stack) using net-template.yaml, with IAM permissions and the parameter Env=dev.

```bash
aws cloudformation deploy \
  --stack-name net-stack \
  --template-file net-template.yaml \
  --capabilities CAPABILITY_NAMED_IAM \
  --parameter-overrides Env=dev
```

### SSM session
The following example starts an interactive AWS Systems Manager (SSM) session to the EC2 instance i-0123456789abcdef0, allowing you to access the instance without SSH.
```bash
  aws ssm start-session --target i-0123456789abcdef0
```

### DynamoDB list tables
The following example lists all DynamoDB table names in your account for the current region.
```bash
  aws dynamodb list-tables --query 'TableNames'
```
---

## 15. Security Practices & Least Privilege

- Confirm account & region before destructive actions:
```bash
    aws sts get-caller-identity --query Account
```
```bash
    aws configure get region
```

- Avoid storing secrets plainly:
```bash
    aws secretsmanager create-secret --name demo/creds --secret-string '{"user":"svc","pwd":"P@ss"}'
```
- Remove temporary credentials:
```bash
  unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN
```
- Use least privilege IAM policies; adopt role-per-task model.
  
- Clear shell history if sensitive commands executed:
  ```bash
    history -d $(history | tail -1 | awk '{print $1}')
  ```

---

## 16. Performance & Limits
| Aspect | Typical Value / Note |
|--------|----------------------|
| Persistent Storage | 1 GB per region in `$HOME` |
| Session Timeout | Idle session ends (inactivity period, varies) |
| CPU/RAM | Sufficient for scripting; not for builds / large compiles |
| Outbound Network | Allowed (subject to org/network policies) |
| Inbound Access | No inbound to shell (browser-based) |
| Package Persistence | Only user-level (`$HOME`); system packages ephemeral |
| Long Running Jobs | Terminate if session closes; design idempotent scripts |

---

## 17. Troubleshooting
| Issue | Symptom | Likely Cause | Resolution |
|-------|---------|--------------|-----------|
| AccessDenied | CLI call fails | Missing IAM permissions | Assume correct role / adjust policy |
| Disk full | Write errors | 1 GB quota reached | Remove old logs, offload to S3 |
| Lost `yum` package | Missing after restart | Ephemeral system layer | Add to bootstrap script; reinstall |
| Python import error | Module not found | Not installed with `--user` or venv | `pip3 install --user <pkg>` |
| Region mismatch | Empty results | Wrong default region | `aws configure set region <region>` or use `--region` |
| AssumeRole fails | AccessDenied | Trust policy missing principal | Update trust / add sts:AssumeRole |
| Terminal freeze | Unresponsive | Browser/network glitch | Close & reopen CloudShell |
| Long script stops | Session ended | Idle timeout reached | Add periodic output / consider remote execution (e.g., SSM Run Command) |
| Git push auth fail | 403 / auth error | Missing PAT / SSO token | Create PAT or configure credential helper |
| Large file upload slow | Lag | Browser pipeline limit | Use S3 multipart or compress first |

---

## 18. Cleanup & Storage Reclamation

### Top space consumers
```bash
  du -sh ~/* 2>/dev/null | sort -hr | head
```

### Remove pip caches
```bash
  rm -rf ~/.cache/pip/*
```

### Compress & offload logs
```bash
  tar czf logs-$DATE.tgz ~/logs 2>/dev/null || echo "No logs dir"
```
```bash
  aws s3 cp logs-$DATE.tgz s3://my-cloudshell-archives/
```
```bash
  rm -rf ~/logs
```

### Delete old scripts

(>7 days):
```bash
  find ~/ -type f -name "*.sh" -mtime +7 -print -delete
```
Finds and deletes all .sh script files in your home directory that were modified within the last 1 day.
```bash
  find ~/ -type f -name "*.sh" -mtime -1 -print -delete
```

### List large (>10MB) files
```bash
  find ~ -type f -size +10M -exec ls -lh {} \; | awk '{print $5, $9}'
```

### Remove everything from your home directory (Dangerous)
```bash
  rm -rf ~/*
```

---

## 19. Best Practices Recap
- Always verify account & region before resource changes.
- Keep `bootstrap.sh` to reestablish ephemeral packages quickly.
- Use parameterized scripts → avoid hard-coded ARNs.
- Prefer storing large data & archives in S3; maintain small `$HOME`.
- Use JMESPath queries to minimize noisy output.
- Commit scripts to git for versioning & rollback.
- Clean environment variables containing secrets promptly.
- Tag all created resources for cost and ownership.
- Use `aws configure set cli_pager ""` to avoid pagination confusion.
- Break big workflows into idempotent steps.

---

## 20. Notes & References
- Some system services (Docker daemon, systemd) are unavailable.
- Use SSM or AWS CodeBuild for heavy build tasks.
- `tmux` / `screen` may not be pre-installed; if needed, install each session (ephemeral).
- Keep external secret retrieval via AWS Secrets Manager / Parameter Store.
- Official docs:
  - CloudShell: https://docs.aws.amazon.com/cloudshell/latest/userguide/working-with-cloudshell.html
  - AWS CLI: https://docs.aws.amazon.com/cli/latest/userguide/
  - JMESPath: https://jmespath.org/
  - Boto3: https://boto3.amazonaws.com/v1/documentation/api/latest/index.html
---
