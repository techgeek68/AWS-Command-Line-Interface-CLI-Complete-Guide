# AWS CLI – IAM Operations Guide

> Replace 123456789012 with your AWS Account ID. Example credentials shown are placeholders.

## Table of Contents
1. [Overview](#overview)  
2. [Identity Types](#identity-types)  
3. [Users](#users)  
4. [Groups](#groups)  
5. [Policies](#policies)  
6. [Roles](#roles)  
7. [Access Keys](#access-keys)  
8. [Permission Boundaries](#permission-boundaries)  
9. [Policy Evaluation & Analysis](#policy-evaluation--analysis)  
10. [Auditing & Reports](#auditing--reports)  
11. [Best Practices](#best-practices)  
12. [Troubleshooting](#troubleshooting)  
13. [Cleanup Sequences](#cleanup-sequences)  
14. [Notes](#notes)

---

## Overview
AWS Identity and Access Management (IAM) provides fine‑grained control of access to AWS services and resources using *principals* (users, roles), *policies*, and *temporary credentials* (STS).  
General approach:
- Favor federation / IAM Identity Center (SSO) + roles.
- Avoid long‑lived IAM user access keys unless absolutely required.
- Apply least privilege early and iterate.

---

## Identity Types
| Type | Typical Use | Key Points |
|------|-------------|-----------|
| User | Legacy apps, limited automation (discouraged for humans) | Static identity; may have console password & access keys |
| Group | Manage user permissions collectively | Only managed/inline policies attach to groups |
| Role | Service/app workloads, cross-account, human sessions | Assumed for temporary credentials via STS |
| Policy | Definition of allowed/denied actions | Managed (AWS / customer) or inline |

---

## Users

### List users
```bash
aws iam list-users --query 'Users[].UserName'
```
Example output:
```json
[
  "DevUser",
  "OpsAuditor"
]
```

### Create a user (no console password)
```bash
aws iam create-user --user-name DevUser \
  --tags Key=Owner,Value=Platform Key=Env,Value=Dev
```

### Add user to a group
```bash
aws iam add-user-to-group --user-name DevUser --group-name Developers
```

### List groups for a user
```bash
aws iam list-groups-for-user --user-name DevUser --query 'Groups[].GroupName'
```

### Attach a managed policy directly (prefer group instead)
```bash
aws iam attach-user-policy \
  --user-name DevUser \
  --policy-arn arn:aws:iam::aws:policy/ReadOnlyAccess
```

### List attached managed policies (user)
```bash
aws iam list-attached-user-policies --user-name DevUser \
  --query 'AttachedPolicies[].PolicyName'
```

### Create & attach an inline policy
File: devuser-s3-list.json
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowListBuckets",
      "Effect": "Allow",
      "Action": ["s3:ListAllMyBuckets"],
      "Resource": "*"
    }
  ]
}
```
Apply:
```bash
aws iam put-user-policy \
  --user-name DevUser \
  --policy-name DevUserS3List \
  --policy-document file://devuser-s3-list.json
```

### Remove inline policy
```bash
aws iam delete-user-policy --user-name DevUser --policy-name DevUserS3List
```

### Delete user (after cleanup)
```bash
aws iam delete-user --user-name DevUser
```

---

## Groups

### Create group
```bash
aws iam create-group --group-name Developers
```

### Attach managed policy to group
```bash
aws iam attach-group-policy \
  --group-name Developers \
  --policy-arn arn:aws:iam::aws:policy/PowerUserAccess
```

### List attached policies
```bash
aws iam list-attached-group-policies --group-name Developers \
  --query 'AttachedPolicies[].PolicyName'
```

### Detach policy
```bash
aws iam detach-group-policy \
  --group-name Developers \
  --policy-arn arn:aws:iam::aws:policy/PowerUserAccess
```

### Delete group
```bash
aws iam delete-group --group-name Developers
```

---

## Policies

### List AWS managed policies with keyword
```bash
aws iam list-policies --scope AWS \
  --query "Policies[?contains(PolicyName,'ReadOnly')].PolicyName" \
  --max-items 25
```

### Retrieve a managed policy's default document
```bash
POL_ARN=arn:aws:iam::aws:policy/ReadOnlyAccess
VER=$(aws iam get-policy --policy-arn "$POL_ARN" --query 'Policy.DefaultVersionId' --output text)
aws iam get-policy-version --policy-arn "$POL_ARN" --version-id "$VER" \
  --query 'PolicyVersion.Document'
```

### Create a customer managed policy
File: my-s3-ro.json
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ListAndReadBucket",
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket",
        "s3:GetObject"
      ],
      "Resource": [
        "arn:aws:s3:::my-app-logs",
        "arn:aws:s3:::my-app-logs/*"
      ]
    }
  ]
}
```
Create:
```bash
aws iam create-policy --policy-name MyS3ReadOnly \
  --policy-document file://my-s3-ro.json
```

### Create a new policy version & set default
```bash
aws iam create-policy-version \
  --policy-arn arn:aws:iam::123456789012:policy/MyS3ReadOnly \
  --policy-document file://my-s3-ro-v2.json \
  --set-as-default
```

### Prune non-default versions
```bash
aws iam list-policy-versions \
  --policy-arn arn:aws:iam::123456789012:policy/MyS3ReadOnly \
  --query 'Versions[?IsDefaultVersion==`false`].VersionId' --output text | \
  xargs -n1 -I{} aws iam delete-policy-version \
    --policy-arn arn:aws:iam::123456789012:policy/MyS3ReadOnly --version-id {}
```

---

## Roles

### EC2 instance trust policy (trust-ec2.json)
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "Service": "ec2.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

### Create role
```bash
aws iam create-role \
  --role-name AppInstanceRole \
  --assume-role-policy-document file://trust-ec2.json \
  --tags Key=Owner,Value=Platform Key=Env,Value=Prod
```

### Attach AWS managed policy to role
```bash
aws iam attach-role-policy \
  --role-name AppInstanceRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
```

### Inline policy for logging (app-inline.json)
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowPutLogs",
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    }
  ]
}
```
Apply:
```bash
aws iam put-role-policy --role-name AppInstanceRole \
  --policy-name AppLogs \
  --policy-document file://app-inline.json
```

### List attached managed policies (role)
```bash
aws iam list-attached-role-policies --role-name AppInstanceRole \
  --query 'AttachedPolicies[].PolicyName'
```

### Cross-account trust (Account A trusts Account B)
File: trust-cross.json
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": { "AWS": "arn:aws:iam::222222222222:root" },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "external-analytics"
        }
      }
    }
  ]
}
```

### Assume role
```bash
aws sts assume-role \
  --role-arn arn:aws:iam::123456789012:role/AppInstanceRole \
  --role-session-name testSession \
  --duration-seconds 1800 > /tmp/session.json

export AWS_ACCESS_KEY_ID=$(jq -r '.Credentials.AccessKeyId' /tmp/session.json)
export AWS_SECRET_ACCESS_KEY=$(jq -r '.Credentials.SecretAccessKey' /tmp/session.json)
export AWS_SESSION_TOKEN=$(jq -r '.Credentials.SessionToken' /tmp/session.json)
```

### Detach & delete role (order matters)
```bash
aws iam list-attached-role-policies --role-name AppInstanceRole \
  --query 'AttachedPolicies[].PolicyArn' --output text | \
  xargs -n1 -I{} aws iam detach-role-policy --role-name AppInstanceRole --policy-arn {}

aws iam delete-role-policy --role-name AppInstanceRole --policy-name AppLogs
aws iam delete-role --role-name AppInstanceRole
```

---

## Access Keys
(Use sparingly; prefer roles & federation.)

### Create access key
```bash
aws iam create-access-key --user-name DevUser
```
Output (example):
```json
{
  "AccessKey": {
    "UserName": "DevUser",
    "AccessKeyId": "AKIAIOSFODNN7EXAMPLE",
    "Status": "Active",
    "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
    "CreateDate": "2025-08-28T02:55:17+00:00"
  }
}
```
Store securely (e.g., AWS credentials file or secrets manager). Do not commit.

### List access keys
```bash
aws iam list-access-keys --user-name DevUser \
  --query 'AccessKeyMetadata[].AccessKeyId'
```

### Deactivate key
```bash
aws iam update-access-key \
  --user-name DevUser \
  --access-key-id AKIAIOSFODNN7EXAMPLE \
  --status Inactive
```

### Delete key
```bash
aws iam delete-access-key \
  --user-name DevUser \
  --access-key-id AKIAIOSFODNN7EXAMPLE
```

---

## Permission Boundaries
Limit the *maximum* permissions a principal can exercise.

### Create boundary policy
File: boundary.json
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:*",
        "ec2:Describe*"
      ],
      "Resource": "*"
    }
  ]
}
```
Create:
```bash
aws iam create-policy --policy-name DevBoundary \
  --policy-document file://boundary.json
```

### Create role with boundary
```bash
aws iam create-role \
  --role-name BoundedDevRole \
  --assume-role-policy-document file://trust-ec2.json \
  --permissions-boundary arn:aws:iam::123456789012:policy/DevBoundary
```

### Inspect boundary
```bash
aws iam get-role --role-name BoundedDevRole --query 'Role.PermissionsBoundary'
```

---

## Policy Evaluation & Analysis

### Simulate principal actions
```bash
aws iam simulate-principal-policy \
  --policy-source-arn arn:aws:iam::123456789012:user/DevUser \
  --action-names s3:ListAllMyBuckets ec2:DescribeInstances sts:GetCallerIdentity \
  --query 'EvaluationResults[].{Action:EvalActionName,Decision:EvalDecision}'
```

### Validate a policy document (structural & analyzer findings)
```bash
aws iam validate-policy \
  --policy-document file://my-s3-ro.json \
  --query 'Findings[].[FindingType,IssueCode,Message]'
```

### Generate service last accessed details (role)
```bash
JOB_ID=$(aws iam generate-service-last-accessed-details \
  --arn arn:aws:iam::123456789012:role/AppInstanceRole \
  --query 'JobId' --output text)

aws iam get-service-last-accessed-details --job-id "$JOB_ID" \
  --query 'ServicesLastAccessed[?ServiceName==`Amazon Simple Storage Service`]'
```

### Access Analyzer (policy generation from activity – example)
```bash
aws accessanalyzer start-policy-generation \
  --principal-arn arn:aws:iam::123456789012:user/DevUser \
  --cloud-trail-details accessRole=<CLOUDTRAIL_ROLE> \
      startTime=2025-08-01T00:00:00Z endTime=2025-08-28T00:00:00Z
```

---

## Auditing & Reports

### List roles
```bash
aws iam list-roles --query 'Roles[].RoleName'
```

### Account summary (usage & quotas)
```bash
aws iam get-account-summary \
  --query 'SummaryMap.{Users:Users,Groups:Groups,Roles:Roles,Policies:Policies}'
```

### Credential report (CSV)
```bash
aws iam generate-credential-report
# Poll until State = COMPLETE
aws iam get-credential-report --query 'Content' --output text | base64 --decode > credential-report.csv
```

### Decode credential report (inline view)
```bash
aws iam get-credential-report --query 'Content' --output text | base64 --decode | head
```

---

## Best Practices
- Prefer *roles + short-lived sessions* (STS) over IAM user access keys.
- Enforce MFA with condition: `"Bool": {"aws:MultiFactorAuthPresent": "true"}` for sensitive operations.
- Apply least privilege — start narrow; expand only when justified.
- Separate duties (deployment vs. audit vs. break-glass).
- Use permission boundaries + SCPs for layered defense.
- Tag principals (`Owner`, `CostCenter`, `Environment`, `App`).
- Review unused roles/policies via service last accessed & credential reports.
- Keep policy documents DRY; reuse managed policies where logical.
- Use condition keys (e.g. `aws:SourceVpce`, `s3:prefix`, `kms:ViaService`) to restrict context.
- Eliminate inactive / unused access keys; target zero human static keys.

---

## Troubleshooting
| Issue | Likely Cause | Resolution |
|-------|--------------|-----------|
| AccessDenied | Missing action or explicit deny (SCP / boundary / session policy) | Simulate policy; inspect SCPs; review boundary & attached policies |
| Cannot delete user | Residual keys/policies/groups/login profile/MFA device | Remove keys, detach policies, remove from groups, delete login profile/MFA |
| AssumeRole AccessDenied | Trust policy principal mismatch or missing ExternalId/MFA | Check trust JSON; add correct `Principal` & `Condition`; retry |
| Policy size error | Exceeded doc size (6144 inline / 10240 managed) | Split statements; remove redundancy; use multiple managed policies |
| MFA required error | Condition enforces MFA presence | Obtain session via `aws sts get-session-token` (with MFA) or assume MFA role |
| Boundary prevents action | Action not allowed in permissions boundary | Amend boundary or remove boundary after review |
| SCP blocks action | Org-level SCP deny | Examine SCPs at OU/root; adjust placement or modify SCP |
| Throttling | Excessive IAM API calls | Add backoff; batch operations |
| Invalid principal in trust | Deleted / wrong account or service typo | Correct ARN/service and re-update trust policy |

---

## Cleanup Sequences

### Delete a user completely
```bash
USER=DevUser

# Detach managed policies
aws iam list-attached-user-policies --user-name "$USER" \
  --query 'AttachedPolicies[].PolicyArn' --output text | \
  xargs -r -n1 -I{} aws iam detach-user-policy --user-name "$USER" --policy-arn {}

# Delete inline policies
aws iam list-user-policies --user-name "$USER" \
  --query 'PolicyNames[]' --output text | \
  xargs -r -n1 -I{} aws iam delete-user-policy --user-name "$USER" --policy-name {}

# Delete access keys
aws iam list-access-keys --user-name "$USER" \
  --query 'AccessKeyMetadata[].AccessKeyId' --output text | \
  xargs -r -n1 -I{} aws iam delete-access-key --user-name "$USER" --access-key-id {}

# Remove from groups
aws iam list-groups-for-user --user-name "$USER" \
  --query 'Groups[].GroupName' --output text | \
  xargs -r -n1 -I{} aws iam remove-user-from-group --user-name "$USER" --group-name {}

# Delete login profile (ignore error if absent)
aws iam delete-login-profile --user-name "$USER" 2>/dev/null || true

# Delete MFA devices (if virtual)
# aws iam deactivate-mfa-device --user-name "$USER" --serial-number <MFA_ARN>
# aws iam delete-virtual-mfa-device --serial-number <MFA_ARN>

aws iam delete-user --user-name "$USER"
```

### Remove a customer-managed policy
```bash
POL_ARN=arn:aws:iam::123456789012:policy/MyS3ReadOnly

# Ensure no attachments
aws iam list-entities-for-policy --policy-arn "$POL_ARN" \
  --query '{Users:PolicyUsers[].UserName,Roles:PolicyRoles[].RoleName,Groups:PolicyGroups[].GroupName}'

# Detach from roles/users/groups first (loop as needed), then:
aws iam list-policy-versions --policy-arn "$POL_ARN" \
  --query 'Versions[?IsDefaultVersion==`false`].VersionId' --output text | \
  xargs -r -n1 -I{} aws iam delete-policy-version --policy-arn "$POL_ARN" --version-id {}

aws iam delete-policy --policy-arn "$POL_ARN"
```

---

## Notes
- Sample AccessKey/SecretKey values are placeholders (never reuse).
- Replace account IDs, resource names, and external IDs with real values.
- AWS CLI v2 recommended.
- Validate policies before attaching them in production environments.

---
