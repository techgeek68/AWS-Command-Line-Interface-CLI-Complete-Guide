# AWS CLI — SQS (Simple Queue Service) Operations Guide

---
> Replace sample queue names / ARNs / account IDs (123456789012) with your own.
---
> Covers: Queue creation (Standard & FIFO), attributes, redrive (DLQ), encryption, access policies, message send/receive/delete, batching, message attributes, visibility timeout, long polling, delays, monitoring, troubleshooting, cleanup, and automation patterns.
---

## Table of Contents
1. Overview  
2. Quick Reference Variables  
3. Queue Types & Core Attributes  
4. Create / List / Describe / Delete Queues  
5. Queue Attribute Management (Get / Set)  
6. Dead-Letter Queues (Redrive Policy)  
7. Encryption (SSE / KMS)  
8. Access Policies & Cross-Account Permissions  
9. Message Operations (Send / Receive / Delete / Change Visibility)  
10. Message Attributes & Deduplication (FIFO)  
11. Batch Operations  
12. Delays & Long Polling (Reducing Empty Responses)  
13. FIFO Queues (Exactly-Once & Ordering)  
14. Monitoring & Metrics (CloudWatch)  
15. Tagging  
16. Best Practices  
17. Troubleshooting  
18. Automation Snippets  
19. Cleanup Sequences  
20. Notes

---

## 1. Overview
Amazon SQS provides fully managed messaging with two queue types:
- Standard: High throughput, at-least-once delivery, best-effort ordering.
- FIFO (suffix `.fifo`): Exactly-once processing (when used correctly), strict ordering per MessageGroupId, lower throughput per queue (can scale using multiple groups).

Key concepts:
- Visibility Timeout: Lock period while a consumer processes a message.
- Redrive (DLQ): Moves messages that exceed max receive attempts.
- Long Polling: Reduces empty responses & cost (up to 20s wait).
- Message Attributes: Key-value metadata enabling selective handling.
- Delay: Per-queue or per-message deferral.
- Encryption: KMS-based at-rest SSE.

---

## 2. Quick Reference Variables
```bash
export ACCOUNT_ID=123456789012
export REGION=us-east-1
export STD_QUEUE=orders-standard
export FIFO_QUEUE=orders-events.fifo
export DLQ=orders-dead-letter
export KMS_KEY_ARN=arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555
```

---

## 3. Queue Types & Core Attributes
Common attributes you may manage:
- VisibilityTimeout (default 30s)
- MessageRetentionPeriod (default 345600 = 4 days; max 1209600 = 14 days)
- ReceiveMessageWaitTimeSeconds (for long polling; 0–20)
- DelaySeconds (0–900)
- RedrivePolicy (JSON: dead-letter target & maxReceiveCount)
- MaximumMessageSize (default 262144 bytes)
- KmsMasterKeyId / KmsDataKeyReusePeriodSeconds (encryption)
- FifoQueue=true (FIFO)
- ContentBasedDeduplication=true (FIFO only)
- DeduplicationScope / FifoThroughputLimit (advanced FIFO settings)

---

## 4. Create / List / Describe / Delete Queues

### 4.1 Create Standard Queue
Syntax:
```bash
aws sqs create-queue --queue-name <QUEUE_NAME>
```
Example:
```bash
aws sqs create-queue --queue-name orders-standard
```

### 4.2 Create FIFO Queue
Syntax:
```bash
aws sqs create-queue \
  --queue-name <QUEUE_NAME>.fifo \
  --attributes FifoQueue=true,ContentBasedDeduplication=true
```
Example:
```bash
aws sqs create-queue \
  --queue-name orders-events.fifo \
  --attributes FifoQueue=true,ContentBasedDeduplication=true
```

### 4.3 List Queues
Syntax:
```bash
aws sqs list-queues
```
Example (filter prefix):
```bash
aws sqs list-queues --queue-name-prefix orders
```

### 4.4 Get Queue URL
Syntax:
```bash
aws sqs get-queue-url --queue-name <QUEUE_NAME>
```
Example:
```bash
QUEUE_URL=$(aws sqs get-queue-url --queue-name orders-standard --query 'QueueUrl' --output text)
echo $QUEUE_URL
```

### 4.5 Delete Queue
Syntax:
```bash
aws sqs delete-queue --queue-url <QUEUE_URL>
```
Example:
```bash
aws sqs delete-queue --queue-url $QUEUE_URL
```

---

## 5. Queue Attribute Management (Get / Set)

### 5.1 Get Attributes
Syntax:
```bash
aws sqs get-queue-attributes --queue-url <QUEUE_URL> --attribute-names All
```
Example:
```bash
aws sqs get-queue-attributes \
  --queue-url $QUEUE_URL \
  --attribute-names VisibilityTimeout ApproximateNumberOfMessages
```

### 5.2 Set Queue Attributes (e.g., Long Polling & Visibility Timeout)
Syntax:
```bash
aws sqs set-queue-attributes --queue-url <QUEUE_URL> --attributes <KEY>=<VALUE>,<KEY2>=<VALUE2>
```
Example:
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes VisibilityTimeout=45,ReceiveMessageWaitTimeSeconds=15
```

### 5.3 Change Message Retention
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes MessageRetentionPeriod=604800   # 7 days
```

---

## 6. Dead-Letter Queues (Redrive Policy)

### 6.1 Create DLQ
```bash
aws sqs create-queue --queue-name orders-dead-letter
DLQ_URL=$(aws sqs get-queue-url --queue-name orders-dead-letter --query 'QueueUrl' --output text)
DLQ_ARN=$(aws sqs get-queue-attributes --queue-url $DLQ_URL --attribute-names QueueArn --query 'Attributes.QueueArn' --output text)
```

### 6.2 Attach Redrive Policy to Source Queue
Syntax:
```bash
aws sqs set-queue-attributes --queue-url <SOURCE_URL> --attributes RedrivePolicy='{"deadLetterTargetArn":"<DLQ_ARN>","maxReceiveCount":"<N>"}'
```
Example:
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes RedrivePolicy='{"deadLetterTargetArn":"'"$DLQ_ARN"'","maxReceiveCount":"5"}'
```

### 6.3 Inspect DLQ for poisoned messages
```bash
aws sqs get-queue-attributes --queue-url $DLQ_URL --attribute-names ApproximateNumberOfMessages
```

---

## 7. Encryption (SSE / KMS)

### 7.1 Create Encrypted Queue
```bash
aws sqs create-queue \
  --queue-name orders-secure \
  --attributes KmsMasterKeyId=$KMS_KEY_ARN
```

### 7.2 Add Encryption to Existing Queue
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes KmsMasterKeyId=$KMS_KEY_ARN,KmsDataKeyReusePeriodSeconds=300
```

### 7.3 Verify Encryption
```bash
aws sqs get-queue-attributes --queue-url $QUEUE_URL --attribute-names KmsMasterKeyId
```

---

## 8. Access Policies & Cross-Account Permissions

### 8.1 Add Policy Allowing Specific SNS Topic to Send
File `sqs-policy.json`:
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Sid":"AllowSNSSend",
      "Effect":"Allow",
      "Principal":"*",
      "Action":"SQS:SendMessage",
      "Resource":"arn:aws:sqs:us-east-1:123456789012:orders-standard",
      "Condition":{
        "ArnEquals":{"aws:SourceArn":"arn:aws:sns:us-east-1:123456789012:orders-events"}
      }
    }
  ]
}
```
Apply:
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes Policy="$(jq -c . sqs-policy.json)"
```

### 8.2 Cross-Account Consumer (Grant IAM Role)
Add principal AWS account/role to policy with `SQS:ReceiveMessage`, `SQS:DeleteMessage`.

---

## 9. Message Operations (Send / Receive / Delete / Change Visibility)

### 9.1 Send Message
Syntax:
```bash
aws sqs send-message --queue-url <QUEUE_URL> --message-body "<BODY>"
```
Example:
```bash
aws sqs send-message --queue-url $QUEUE_URL --message-body "Order O10002 created"
```

### 9.2 Send with Delay (per message)
```bash
aws sqs send-message \
  --queue-url $QUEUE_URL \
  --message-body "Processing after delay" \
  --delay-seconds 30
```

### 9.3 Receive Messages
Syntax:
```bash
aws sqs receive-message --queue-url <QUEUE_URL> --max-number-of-messages <N>
```
Example (attributes + visibility override):
```bash
aws sqs receive-message \
  --queue-url $QUEUE_URL \
  --max-number-of-messages 5 \
  --visibility-timeout 60 \
  --wait-time-seconds 10 \
  --message-attribute-names All
```

### 9.4 Delete Message
Syntax:
```bash
aws sqs delete-message --queue-url <QUEUE_URL> --receipt-handle "<RECEIPT_HANDLE>"
```
Example:
```bash
RECEIPT=$(aws sqs receive-message --queue-url $QUEUE_URL --query 'Messages[0].ReceiptHandle' --output text)
aws sqs delete-message --queue-url $QUEUE_URL --receipt-handle "$RECEIPT"
```

### 9.5 Change Message Visibility (extend processing time)
```bash
aws sqs change-message-visibility \
  --queue-url $QUEUE_URL \
  --receipt-handle "$RECEIPT" \
  --visibility-timeout 120
```

---

## 10. Message Attributes & Deduplication (FIFO)

### 10.1 Send with Message Attributes
```bash
aws sqs send-message \
  --queue-url $QUEUE_URL \
  --message-body '{"orderId":"O10005","event":"CREATED"}' \
  --message-attributes 'OrderType={DataType=String,StringValue=Express},Priority={DataType=Number,StringValue=10}'
```

### 10.2 Inspect Attributes
```bash
aws sqs receive-message \
  --queue-url $QUEUE_URL \
  --message-attribute-names All \
  --max-number-of-messages 1
```

### 10.3 FIFO Dedup & Group
(Requires FIFO queue URL)
```bash
FIFO_URL=$(aws sqs get-queue-url --queue-name $FIFO_QUEUE --query 'QueueUrl' --output text)
aws sqs send-message \
  --queue-url $FIFO_URL \
  --message-body '{"orderId":"O10010","event":"CREATED"}' \
  --message-group-id Order-O10010 \
  --message-deduplication-id O10010-CREATED
```
If ContentBasedDeduplication enabled, omit `--message-deduplication-id`.

---

## 11. Batch Operations

### 11.1 Batch Send (up to 10)
Create `batch-send.json`:
```json
{
  "Entries": [
    {"Id":"m1","MessageBody":"Batch order 1"},
    {"Id":"m2","MessageBody":"Batch order 2","DelaySeconds":10},
    {"Id":"m3","MessageBody":"Batch order 3"}
  ]
}
```
Send:
```bash
aws sqs send-message-batch --queue-url $QUEUE_URL --entries file://batch-send.json
```

### 11.2 Batch Delete
Retrieve messages first:
```bash
aws sqs receive-message --queue-url $QUEUE_URL --max-number-of-messages 10 > /tmp/messages.json
```
Transform to batch entries (example using jq):
```bash
jq '{Entries: [.Messages[] | {Id: .MessageId, ReceiptHandle: .ReceiptHandle}]}' /tmp/messages.json > /tmp/delete-batch.json
aws sqs delete-message-batch --queue-url $QUEUE_URL --entries file:///tmp/delete-batch.json
```

---

## 12. Delays & Long Polling (Reducing Empty Responses)

### 12.1 Set Queue-Level Long Polling
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes ReceiveMessageWaitTimeSeconds=20
```

### 12.2 Per-Receive Long Poll (override)
```bash
aws sqs receive-message \
  --queue-url $QUEUE_URL \
  --wait-time-seconds 15
```

### 12.3 Set Default Delay (All Messages)
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes DelaySeconds=5
```

---

## 13. FIFO Queues (Exactly-Once & Ordering)

### 13.1 Create FIFO with High Throughput (per docs)
```bash
aws sqs create-queue \
  --queue-name high-throughput.fifo \
  --attributes FifoQueue=true,FifoThroughputLimit=perMessageGroupId,DeduplicationScope=messageGroup,ContentBasedDeduplication=true
```

### 13.2 Receive FIFO Messages
(Identical CLI, order maintained per group)
```bash
aws sqs receive-message --queue-url $FIFO_URL --max-number-of-messages 5
```

---

## 14. Monitoring & Metrics (CloudWatch)

Common metrics: ApproximateNumberOfMessagesVisible, ApproximateAgeOfOldestMessage, NumberOfMessagesSent, NumberOfMessagesDeleted, NumberOfMessagesReceived, SentMessageSize.

### 14.1 Approximate Number Of Messages (API call)
```bash
aws sqs get-queue-attributes --queue-url $QUEUE_URL --attribute-names ApproximateNumberOfMessages
```

### 14.2 CloudWatch Metric (Messages Visible last 15m)
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/SQS \
  --metric-name ApproximateNumberOfMessagesVisible \
  --dimensions Name=QueueName,Value=orders-standard \
  --start-time "$(date -u -d '15 minutes ago' +%FT%TZ)" \
  --end-time   "$(date -u +%FT%TZ)" \
  --period 60 \
  --statistics Average \
  --query 'Datapoints|sort_by(@,&Timestamp)[].{T:Timestamp,Avg:Average}'
```

### 14.3 Age of Oldest Message (Alert Candidate)
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/SQS \
  --metric-name ApproximateAgeOfOldestMessage \
  --dimensions Name=QueueName,Value=orders-standard \
  --start-time "$(date -u -d '30 minutes ago' +%FT%TZ)" \
  --end-time   "$(date -u +%FT%TZ)" \
  --period 300 \
  --statistics Maximum
```

---

## 15. Tagging

### 15.1 Tag Queue
```bash
aws sqs tag-queue \
  --queue-url $QUEUE_URL \
  --tags Env=dev Service=Orders
```

### 15.2 List Tags
```bash
aws sqs list-queue-tags --queue-url $QUEUE_URL
```

### 15.3 Untag
```bash
aws sqs untag-queue --queue-url $QUEUE_URL --tag-keys Env
```

---

## 16. Best Practices
- Prefer long polling (ReceiveMessageWaitTimeSeconds 10–20) to reduce empty receives and cost.
- Use DLQs for poison-pill handling; monitor DLQ depth.
- Keep messages small; for large payloads store in S3 and send pointer metadata.
- For high throughput ordering, partition by MessageGroupId (FIFO).
- Avoid excessive visibility timeout; set slightly larger than max processing time, adjust with ChangeMessageVisibility when needed.
- Use batch API for throughput & lower costs (send/receive/delete in groups).
- Monitor ApproximateAgeOfOldestMessage & approximate counts to detect backlog.
- Encrypt queues containing sensitive data with a CMK and restrict decrypt rights.
- Use message attributes for lightweight routing & filtering by consumers.
- Clean up unused queues to avoid accidental production usage/test confusion.
- Implement idempotent consumers (even FIFO can re-deliver on rare failures).
- Validate JSON before sending to ensure consumer reliability.

---

## 17. Troubleshooting
| Issue | Symptom | Likely Cause | Resolution |
|-------|---------|--------------|-----------|
| Messages reappear | Processed but show up again | Visibility timeout too short / consumer crash before delete | Increase visibility timeout; ensure delete after successful processing |
| Growing backlog | ApproximateNumberOfMessagesVisible rising | Consumers scaled down / slow processing | Scale consumers; optimize processing; increase batch size |
| DLQ filling | Many messages in DLQ | MaxReceiveCount reached (poison) | Inspect & fix root cause; replay after correction |
| InvalidParameter | CLI error | Attribute name/ value invalid | Re-check attribute names & allowed ranges |
| AccessDenied | API calls fail | IAM policy lacks SQS action | Add required SQS:SendMessage / ReceiveMessage / DeleteMessage |
| Dedup not working (FIFO) | Duplicate bodies delivered | Missing dedup ID and content changed (timestamp added) | Provide stable `--message-deduplication-id` or avoid variable fields |
| Message too large | API rejects >256KB | Exceeding limit | Offload payload to S3 / compress / split |
| Slow receive | Long waits but backlog exists | Consuming wrong queue or wrong region | Verify queue URL, region, account ID |
| High empty receives | Many empty responses | Long polling not enabled | Set ReceiveMessageWaitTimeSeconds > 0 |
| KMS AccessDenied | Cannot send/receive encrypted | Insufficient kms:Decrypt / GenerateDataKey | Update KMS key policy & IAM principal |
| Batch partial failure | Some Unsuccessful entries | Provisioned throughput / transient error | Retry only failed entries (inspect response) |

---

## 18. Automation Snippets

### 18.1 Idempotent Queue Create (Standard)
```bash
QUEUE_URL=$(aws sqs create-queue --queue-name $STD_QUEUE --query 'QueueUrl' --output text)
echo "Queue URL: $QUEUE_URL"
```

### 18.2 Drain Queue (Delete all messages)
(Receive & delete until empty)
```bash
while :; do
  MSGS=$(aws sqs receive-message --queue-url $QUEUE_URL --max-number-of-messages 10 --wait-time-seconds 2)
  COUNT=$(echo "$MSGS" | jq '.Messages | length' 2>/dev/null || echo 0)
  [ "$COUNT" -eq 0 ] && break
  echo "$MSGS" | jq -r '.Messages[] | "\(.MessageId)\t\(.ReceiptHandle)"' | while IFS=$'\t' read -r ID RH; do
    aws sqs delete-message --queue-url $QUEUE_URL --receipt-handle "$RH"
  done
done
```

### 18.3 Reprocess DLQ (Move messages back to source)
(Example logic)
```bash
DLQ_URL=$(aws sqs get-queue-url --queue-name $DLQ --query 'QueueUrl' --output text)
for i in $(seq 1 50); do
  MSGS=$(aws sqs receive-message --queue-url $DLQ_URL --max-number-of-messages 10 --wait-time-seconds 2 --message-attribute-names All --attribute-names All)
  [ -z "$MSGS" ] && break
  echo "$MSGS" | jq -c '.Messages[]?' | while read M; do
    BODY=$(echo "$M" | jq -r '.Body')
    RH=$(echo "$M" | jq -r '.ReceiptHandle')
    aws sqs send-message --queue-url $QUEUE_URL --message-body "$BODY"
    aws sqs delete-message --queue-url $DLQ_URL --receipt-handle "$RH"
  done
done
```

### 18.4 Visibility Extension (Heartbeat pattern)
```bash
# Example pseudo-loop
RECEIPT=$(aws sqs receive-message --queue-url $QUEUE_URL --query 'Messages[0].ReceiptHandle' --output text)
# Do work ...
aws sqs change-message-visibility --queue-url $QUEUE_URL --receipt-handle "$RECEIPT" --visibility-timeout 120
# Finish then delete
aws sqs delete-message --queue-url $QUEUE_URL --receipt-handle "$RECEIPT"
```

---

## 19. Cleanup Sequences

### 19.1 Delete All Queues with Prefix
```bash
aws sqs list-queues --queue-name-prefix orders | jq -r '.QueueUrls[]' | while read Q; do
  aws sqs delete-queue --queue-url "$Q"
done
```

### 19.2 Remove Redrive Policy (Detach DLQ)
```bash
aws sqs set-queue-attributes \
  --queue-url $QUEUE_URL \
  --attributes RedrivePolicy=''
```

### 19.3 Purge Queue (delete all messages)
(Use carefully; messages cannot be recovered.)
```bash
aws sqs purge-queue --queue-url $QUEUE_URL
```

### 19.4 Delete DLQ
```bash
aws sqs delete-queue --queue-url $DLQ_URL
```

---

## 20. Notes
- Standard queue ordering is not guaranteed; do not depend on sequential processing unless FIFO is used.
- Visibility timeout must exceed max consumer processing time; otherwise, duplicates are likely.
- Approximate metrics are eventually consistent.
- PurgeQueue can be issued only every 60 seconds; it fails otherwise.
- Maximum inflight messages per FIFO group can limit throughput; parallelize via multiple message groups.
- Large payload patterns: store object in S3, send pointer (key, bucket, version).
- Redrive requires both the source queue attribute and the existing DLQ.
- Message attributes count toward the size limit; keep it concise.
- FIFO throughput can be boosted using `FifoThroughputLimit=perMessageGroupId`.
- For fan-out, pair SNS (publish once) -> multiple SQS subscribers.

---
