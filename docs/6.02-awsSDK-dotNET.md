# AWS SDK Developer Guide â€” .NET

> Focus: Setup with `dotnet` CLI, dependency inclusion (`AWSSDK.*` packages), credentials, example (list regions), async patterns, retries, logging, testing.

## Table of Contents
1. Overview
2. Prerequisites
3. Project Setup
4. Adding Dependencies
5. Credentials & Region Resolution
6. Example: List Regions
7. Async & Await Patterns
8. Pagination
9. Retries & Timeouts
10. Logging & Telemetry
11. Testing
12. Common Errors
13. Best Practices

---

## 1. Overview
AWS SDK for .NET supports .NET 6/7/8, offering async-first APIs, credential resolution chain, and integration with configuration providers.

---

## 2. Prerequisites
- .NET 6+ SDK installed (`dotnet --version`).
- AWS credentials (profile/env/role).
- Optional: AWS Toolkit for Visual Studio or JetBrains Rider.

---

## 3. Project Setup
```bash
dotnet new console -n AwsSdkDemo
cd AwsSdkDemo
```

---

## 4. Adding Dependencies
```bash
dotnet add package AWSSDK.EC2
```
Multiple services: add other `AWSSDK.*` packages as required (modular approach reduces deployment size).

---

## 5. Credentials & Region Resolution
Order:
1. Environment variables
2. Shared credentials file (`%UserProfile%\.aws\credentials`)
3. IAM role (EC2/ECS/EKS)
4. SSO credential cache (when configured)
Region override:
```csharp
var cfg = new AmazonEC2Config { RegionEndpoint = Amazon.RegionEndpoint.USEast1 };
var ec2 = new AmazonEC2Client(cfg);
```

---

## 6. Example: List Regions
See `Program.cs`. Run:
```bash
dotnet run
```

---

## 7. Async & Await Patterns
All service methods have async forms: `DescribeRegionsAsync()`.
Ensure using `await` to avoid blocking:
```csharp
var resp = await ec2.DescribeInstancesAsync(new DescribeInstancesRequest());
```

---

## 8. Pagination
Many responses include `NextToken`:
```csharp
string token = null;
do {
  var resp = await ec2.DescribeInstancesAsync(new DescribeInstancesRequest { NextToken = token });
  // process resp.Reservations
  token = resp.NextToken;
} while (token != null);
```

---

## 9. Retries & Timeouts
Default retries configured in `AmazonServiceClient` (exponential backoff).
Custom:
```csharp
var config = new AmazonEC2Config {
  MaxErrorRetry = 5,
  Timeout = TimeSpan.FromSeconds(60),
  ReadWriteTimeout = TimeSpan.FromSeconds(60)
};
var ec2 = new AmazonEC2Client(config);
```

---

## 10. Logging & Telemetry
- Use `AWSSDKHandler.RegisterXRayForAllServices();` for AWS X-Ray integration.
- Leverage `Microsoft.Extensions.Logging` via dependency injection in ASP.NET Core apps.

---

## 11. Testing
| Tool | Use |
|------|-----|
| xUnit / NUnit / MSTest | Unit tests |
| Moq / NSubstitute | Mock interfaces (`IAmazonS3`, etc.) |
| LocalStack | Integration tests |

Mock example:
```csharp
var mock = new Mock<IAmazonEC2>();
mock.Setup(m => m.DescribeRegionsAsync(It.IsAny<DescribeRegionsRequest>(), default))
    .ReturnsAsync(new DescribeRegionsResponse{ Regions = new List<Region>{ new Region{ RegionName="us-east-1"} }});
```

---

## 12. Common Errors
| Error | Cause | Fix |
|-------|-------|-----|
| `AmazonServiceException: AccessDenied` | Missing IAM perms | Update policy |
| `AmazonClientException: No RegionEndpoint` | Region not set & not resolved | Set region in config or env |
| Throttling | Rate limit | Backoff or reduce parallelism |
| `ExpiredToken` | STS creds expired | Refresh / re-assume role |

---

## 13. Best Practices
- Reuse service clients (thread-safe).
- Use async for I/O operations to avoid thread starvation.
- Inject interfaces for testability (e.g., `IAmazonS3`).
- Externalize configuration (appsettings.json, environment).
- Handle `TaskCanceledException` as potential timeout.
- Avoid syncing on async (`.Result` / `.Wait()`).

---
