# AWS CLI â€” Lambda Operations Guide
---
> Replace 123456789012 with your AWS Account ID and adjust region (us-east-1).  
---
> Sample ARNs, role names, log groups, and IDs are illustrative.
---
Sections:
## Table of Contents
1. [Overview](#overview)
2. [Quick Reference Variables](#quick-reference-variables)
3. [IAM Role & Permissions](#iam-role--permissions)
4. [Packaging (Zip) & Basic Function Creation](#packaging-zip--basic-function-creation)
5. [Updating Code & Configuration](#updating-code--configuration)
6. [Versions, Aliases & Traffic Shifting](#versions-aliases--traffic-shifting)
7. [Invocation Patterns (Sync / Async / Dry Run / Response Streaming)](#invocation-patterns-sync--async--dry-run--response-streaming)
8. [Environment Variables & Secrets](#environment-variables--secrets)
9. [Logging, Metrics & Tracing](#logging-metrics--tracing)
10. [Concurrency & Scaling Controls](#concurrency--scaling-controls)
11. [Permissions & Resource-Based Policies](#permissions--resource-based-policies)
12. [Event Source Mappings (SQS, Kinesis, DynamoDB Streams)](#event-source-mappings-sqs-kinesis-dynamodb-streams)
13. [Layers](#layers)
14. [Container Image Functions](#container-image-functions)
15. [VPC Configuration](#vpc-configuration)
16. [Error Handling & DLQ / On-Failure Destinations](#error-handling--dlq--on-failure-destinations)
17. [Code Signing (Brief)](#code-signing-brief)
18. [Automation Snippets](#automation-snippets)
19. [Troubleshooting](#troubleshooting)
20. [Cleanup Sequences](#cleanup-sequences)
21. [Appendix: Example Trust Policy](#appendix-example-trust-policy)
22. [Notes](#notes)

---

## 1. Overview
AWS Lambda executes code without provisioning servers. Key concepts:
- Runtime: Execution environment (python3.11, nodejs20.x, etc.)
- Handler: Entry point (file.method)
- Execution Role: Grants the function AWS permissions
- Versions & Aliases: Immutable snapshots (versions), named pointers (aliases)
- Event Source Mapping: Poll-based triggers (SQS / Kinesis / DynamoDB Streams)
- Concurrency Controls: Reserved concurrency & provisioned concurrency
- Layers: Shared code & dependencies
- Deployment Options: Zip archive, container image

---

## 2. Quick Reference Variables
```bash
export FUNC_NAME=hello-api
export ROLE_NAME=lambda-hello-role
export ROLE_ARN=arn:aws:iam::123456789012:role/$ROLE_NAME
export LAYER_NAME=hello-layer
export ALIAS_NAME=prod
export ACCOUNT_ID=123456789012
export REGION=us-east-1
```

---

## 3. IAM Role & Permissions

### 3.1 Trust policy file (trust-lambda.json)
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Principal":{"Service":"lambda.amazonaws.com"},
      "Action":"sts:AssumeRole"
    }
  ]
}
```

### 3.2 Create execution role
Syntax:
```bash
aws iam create-role --role-name <ROLE_NAME> --assume-role-policy-document file://<TRUST_FILE>
```
Example:
```bash
aws iam create-role \
  --role-name lambda-hello-role \
  --assume-role-policy-document file://trust-lambda.json
```

### 3.3 Attach AWS managed basic logging policy
Syntax:
```bash
aws iam attach-role-policy --role-name <ROLE_NAME> --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
```
Example:
```bash
aws iam attach-role-policy \
  --role-name lambda-hello-role \
  --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
```

### 3.4 (Optional) Add X-Ray tracing policy
```bash
aws iam attach-role-policy \
  --role-name lambda-hello-role \
  --policy-arn arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
```

---

## 4. Packaging (Zip) & Basic Function Creation

### 4.1 Minimal handler (lambda_function.py)
```python
def handler(event, context):
    return {
        "message": "Hello Lambda",
        "input": event
    }
```

### 4.2 Create deployment ZIP
Syntax:
```bash
zip <ZIP_NAME> <HANDLER_FILE>
```
Example:
```bash
zip function.zip lambda_function.py
```

### 4.3 Create function
Syntax:
```bash
aws lambda create-function \
  --function-name <FUNCTION_NAME> \
  --runtime <RUNTIME> \
  --role <ROLE_ARN> \
  --handler <FILE.HANDLER> \
  --zip-file fileb://<ZIP_FILE> \
  [--timeout <SECONDS>] [--memory-size <MB>]
```
Example:
```bash
aws lambda create-function \
  --function-name hello-api \
  --runtime python3.11 \
  --role $ROLE_ARN \
  --handler lambda_function.handler \
  --zip-file fileb://function.zip \
  --timeout 10 \
  --memory-size 256
```

### 4.4 Verify creation
```bash
aws lambda get-function --function-name hello-api \
  --query 'Configuration.{Name:FunctionName,Runtime:Runtime,LastModified:LastModified}'
```

---

## 5. Updating Code & Configuration

### 5.1 Update code (zip redeploy)
Syntax:
```bash
aws lambda update-function-code --function-name <FUNCTION_NAME> --zip-file fileb://<ZIP_FILE>
```
Example:
```bash
aws lambda update-function-code \
  --function-name hello-api \
  --zip-file fileb://function.zip
```

### 5.2 Update configuration (memory/timeout)
Syntax:
```bash
aws lambda update-function-configuration --function-name <FUNCTION_NAME> --memory-size <MB> --timeout <SEC>
```
Example:
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --memory-size 512 \
  --timeout 20
```

### 5.3 Set environment variables
Syntax:
```bash
aws lambda update-function-configuration --function-name <FUNC> --environment "Variables={KEY1=VAL1,KEY2=VAL2}"
```
Example:
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --environment "Variables={STAGE=dev,LOG_LEVEL=INFO}"
```

### 5.4 View configuration
```bash
aws lambda get-function-configuration --function-name hello-api \
  --query '{Name:FunctionName,Mem:MemorySize,Timeout:Timeout,Env:Environment.Variables}'
```

---

## 6. Versions, Aliases & Traffic Shifting

### 6.1 Publish version
Syntax:
```bash
aws lambda publish-version --function-name <FUNCTION_NAME>
```
Example:
```bash
aws lambda publish-version --function-name hello-api
# Output includes Version number (e.g., "Version": "3")
```

### 6.2 List versions
```bash
aws lambda list-versions-by-function --function-name hello-api \
  --query 'Versions[].Version'
```

### 6.3 Create alias
Syntax:
```bash
aws lambda create-alias --function-name <FUNCTION_NAME> --name <ALIAS> --function-version <VERSION>
```
Example:
```bash
aws lambda create-alias \
  --function-name hello-api \
  --name prod \
  --function-version 3
```

### 6.4 Update alias to new version
```bash
aws lambda update-alias \
  --function-name hello-api \
  --name prod \
  --function-version 4
```

### 6.5 Weighted alias (canary / linear)
```bash
aws lambda update-alias \
  --function-name hello-api \
  --name prod \
  --function-version 5 \
  --routing-config AdditionalVersionWeights='{"4":0.10}'
```
(90% to version 5, 10% to version 4.)

---

## 7. Invocation Patterns

### 7.1 Synchronous invoke
Syntax:
```bash
aws lambda invoke --function-name <FUNCTION_NAME> --payload '<JSON>' <RESPONSE_FILE>
```
Example:
```bash
aws lambda invoke \
  --function-name hello-api \
  --payload '{"name":"Alice"}' \
  response.json
cat response.json
```

### 7.2 Invoke alias
Example:
```bash
aws lambda invoke \
  --function-name hello-api:prod \
  --payload file://event.json \
  out.json
```

### 7.3 Dry run (permission test)
Syntax:
```bash
aws lambda invoke --function-name <FUNCTION_NAME> --invocation-type DryRun /dev/null
```
Example:
```bash
aws lambda invoke --function-name hello-api --invocation-type DryRun /dev/null
```

### 7.4 Asynchronous (Event)
Syntax:
```bash
aws lambda invoke --function-name <FUNCTION_NAME> --invocation-type Event --payload '<JSON>' /dev/null
```
Example:
```bash
aws lambda invoke \
  --function-name hello-api \
  --invocation-type Event \
  --payload '{"batch":true}' \
  /dev/null
```

### 7.5 Request response streaming (if runtime supports)
```bash
aws lambda invoke \
  --function-name streaming-func \
  --cli-binary-format raw-in-base64-out \
  --payload '{"query":"stream"}' stream-out.json
```

---

## 8. Environment Variables & Secrets

### 8.1 Update with secure references (Secrets Manager / Parameter Store)
(Use code to resolve inside function; CLI just sets variable.)
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --environment "Variables={STAGE=dev,DB_SECRET_ARN=arn:aws:secretsmanager:us-east-1:123456789012:secret:db-creds-ABC123}"
```

### 8.2 Get environment keys only
```bash
aws lambda get-function-configuration --function-name hello-api \
  --query 'Environment.Variables' 
```

---

## 9. Logging, Metrics & Tracing

### 9.1 Tail logs (requires AWS CLI v2)
Syntax:
```bash
aws logs tail /aws/lambda/<FUNCTION_NAME> --since <DURATION> [--follow]
```
Example:
```bash
aws logs tail /aws/lambda/hello-api --since 5m --follow
```

### 9.2 Describe log streams (most recent)
```bash
aws logs describe-log-streams \
  --log-group-name /aws/lambda/hello-api \
  --order-by LastEventTime \
  --descending \
  --max-items 1
```

### 9.3 Fetch specific log stream events
```bash
aws logs get-log-events \
  --log-group-name /aws/lambda/hello-api \
  --log-stream-name 2025/08/28/[$LATEST]abcdef1234567890 \
  --limit 50
```

### 9.4 Get invocation metric (Invocations)
Syntax:
```bash
aws cloudwatch get-metric-statistics --namespace AWS/Lambda --metric-name Invocations \
  --dimensions Name=FunctionName,Value=<FUNCTION_NAME> \
  --start-time <START_ISO> --end-time <END_ISO> --period 60 --statistics Sum
```
Example:
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Invocations \
  --dimensions Name=FunctionName,Value=hello-api \
  --start-time "$(date -u -d '15 minutes ago' +%FT%TZ)" \
  --end-time "$(date -u +%FT%TZ)" \
  --period 60 \
  --statistics Sum \
  --query 'Datapoints[].{Time:Timestamp,Invocations:Sum}'
```

### 9.5 Enable X-Ray tracing
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --tracing-config Mode=Active
```

---

## 10. Concurrency & Scaling Controls

### 10.1 Set reserved concurrency
Syntax:
```bash
aws lambda put-function-concurrency --function-name <FUNCTION_NAME> --reserved-concurrent-executions <NUMBER>
```
Example:
```bash
aws lambda put-function-concurrency \
  --function-name hello-api \
  --reserved-concurrent-executions 20
```

### 10.2 Remove reserved concurrency limit
```bash
aws lambda delete-function-concurrency --function-name hello-api
```

### 10.3 Provisioned concurrency (only on version or alias)
```bash
aws lambda put-provisioned-concurrency-config \
  --function-name hello-api \
  --qualifier prod \
  --provisioned-concurrent-executions 5
```

### 10.4 Get concurrency config
```bash
aws lambda get-function-concurrency --function-name hello-api
```

---

## 11. Permissions & Resource-Based Policies

### 11.1 Add invoke permission (API Gateway principal)
Syntax:
```bash
aws lambda add-permission \
  --function-name <FUNCTION_NAME> \
  --statement-id <STATEMENT_ID> \
  --action lambda:InvokeFunction \
  --principal apigateway.amazonaws.com \
  [--source-arn <SOURCE_ARN>]
```
Example:
```bash
aws lambda add-permission \
  --function-name hello-api \
  --statement-id apigw-invoke \
  --action lambda:InvokeFunction \
  --principal apigateway.amazonaws.com \
  --source-arn arn:aws:execute-api:us-east-1:123456789012:abc123defg/*/GET/hello
```

### 11.2 View policy
```bash
aws lambda get-policy --function-name hello-api
```

### 11.3 Remove statement
```bash
aws lambda remove-permission --function-name hello-api --statement-id apigw-invoke
```

---

## 12. Event Source Mappings

### 12.1 Create mapping (SQS queue)
Syntax:
```bash
aws lambda create-event-source-mapping \
  --function-name <FUNCTION_NAME> \
  --event-source-arn <QUEUE_ARN> \
  --batch-size <N>
```
Example:
```bash
aws lambda create-event-source-mapping \
  --function-name hello-api \
  --event-source-arn arn:aws:sqs:us-east-1:123456789012:orders-queue \
  --batch-size 10
```

### 12.2 Create mapping (Kinesis)
```bash
aws lambda create-event-source-mapping \
  --function-name hello-api \
  --event-source-arn arn:aws:kinesis:us-east-1:123456789012:stream/payments-stream \
  --starting-position LATEST \
  --maximum-batching-window-in-seconds 2
```

### 12.3 List mappings
```bash
aws lambda list-event-source-mappings --function-name hello-api \
  --query 'EventSourceMappings[].{UUID:UUID,State:State,SourceArn:EventSourceArn}'
```

### 12.4 Update mapping (batch size)
```bash
aws lambda update-event-source-mapping \
  --uuid <UUID> \
  --batch-size 5
```

### 12.5 Delete mapping
```bash
aws lambda delete-event-source-mapping --uuid <UUID>
```

---

## 13. Layers

### 13.1 Create layer (e.g., dependencies.zip)
Syntax:
```bash
aws lambda publish-layer-version \
  --layer-name <LAYER_NAME> \
  --zip-file fileb://<ZIP> \
  --compatible-runtimes <RUNTIME1> <RUNTIME2>
```
Example:
```bash
aws lambda publish-layer-version \
  --layer-name hello-layer \
  --zip-file fileb://layer.zip \
  --compatible-runtimes python3.11
```

### 13.2 List layer versions
```bash
aws lambda list-layer-versions --layer-name hello-layer \
  --query 'LayerVersions[].Version'
```

### 13.3 Add layer to function
```bash
LAYER_ARN=$(aws lambda list-layer-versions --layer-name hello-layer \
  --query 'LayerVersions[0].LayerVersionArn' --output text)

aws lambda update-function-configuration \
  --function-name hello-api \
  --layers $LAYER_ARN
```

---

## 14. Container Image Functions

### 14.1 Build local image (Dockerfile present)
```bash
docker build -t hello-image .
```

### 14.2 Tag & push to ECR
```bash
aws ecr create-repository --repository-name lambda/hello-image 2>/dev/null || true
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
aws ecr get-login-password | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com
docker tag hello-image:latest $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/lambda/hello-image:latest
docker push $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/lambda/hello-image:latest
```

### 14.3 Create function from image
```bash
aws lambda create-function \
  --function-name hello-image-func \
  --package-type Image \
  --code ImageUri=$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/lambda/hello-image:latest \
  --role $ROLE_ARN
```

### 14.4 Update image
```bash
docker build -t hello-image .
docker push $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/lambda/hello-image:latest
aws lambda update-function-code \
  --function-name hello-image-func \
  --image-uri $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/lambda/hello-image:latest
```

---

## 15. VPC Configuration

### 15.1 Update function into VPC
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --vpc-config SubnetIds=subnet-0abc1234def567890,subnet-0123abcd4567efef0 SecurityGroupIds=sg-0123abcd4567ef890
```

### 15.2 Remove VPC config (set empty arrays)
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --vpc-config SubnetIds= SecurityGroupIds=
```

---

## 16. Error Handling & Destinations

### 16.1 Configure async failure destination (SQS)
```bash
aws lambda update-function-event-invoke-config \
  --function-name hello-api \
  --maximum-retry-attempts 1 \
  --destination-config 'OnFailure={Destination=arn:aws:sqs:us-east-1:123456789012:failed-invocations}'
```

### 16.2 Get invoke config
```bash
aws lambda get-function-event-invoke-config --function-name hello-api
```

### 16.3 DLQ (SNS/SQS) via update
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --dead-letter-config TargetArn=arn:aws:sqs:us-east-1:123456789012:lambda-dlq
```

---

## 17. Code Signing (Brief)

### 17.1 List code signing configs
```bash
aws lambda list-code-signing-configs
```

### 17.2 Attach code signing config (example placeholder ARN)
```bash
aws lambda update-function-configuration \
  --function-name hello-api \
  --code-signing-config-arn arn:aws:lambda:us-east-1:123456789012:code-signing-config:csc-abc123
```

---

## 18. Automation Snippets

### 18.1 Scripted deploy (zip build + version + alias shift)
```bash
zip function.zip lambda_function.py
aws lambda update-function-code --function-name hello-api --zip-file fileb://function.zip
VER=$(aws lambda publish-version --function-name hello-api --query 'Version' --output text)
aws lambda update-alias --function-name hello-api --name prod --function-version $VER
```

### 18.2 Canary traffic shift (10% old)
```bash
NEW_VER=$(aws lambda publish-version --function-name hello-api --query Version --output text)
aws lambda update-alias \
  --function-name hello-api \
  --name prod \
  --function-version $NEW_VER \
  --routing-config AdditionalVersionWeights='{"5":0.10}'
```

### 18.3 List functions by tag (requires Resource Groups Tagging API)
```bash
aws resourcegroupstaggingapi get-resources \
  --tag-filters Key=Env,Values=dev \
  --resource-type-filters lambda:function \
  --query 'ResourceTagMappingList[].ResourceARN'
```

---

## 19. Troubleshooting
| Problem | Symptom | Likely Cause | Resolution |
|---------|---------|--------------|-----------|
| Timeout | Function hits full timeout | External network latency / VPC ENI cold | Increase timeout, move out of VPC if not needed, enable provisioned concurrency |
| Throttling | 429 errors or throttled metrics | Reserved concurrency low | Increase reserved concurrency or remove limit |
| Init duration high | Cold start overhead | Large package, VPC attach | Reduce dependencies, use Lambda SnapStart (Java)/provisioned concurrency |
| AccessDenied logs | Failing AWS SDK call | Missing IAM permission | Update execution role policy accordingly |
| DLQ filling | Many async failures | Unhandled exceptions | Add retries/backoff; review error stack in logs |
| Missing logs | No /aws/lambda log group events | Execution role missing logging permission | Ensure AWSLambdaBasicExecutionRole attached |
| Invocation error 403 from API Gateway | Lack of permission | Missing `add-permission` for apigateway | Re-add permission with correct SourceArn |
| Layer size error | Exceeds combined size | Too many large deps | Prune dependencies or use container image |
| Image update not reflected | Old image cached | Lack of version tag change | Use immutable tag (e.g., commit SHA) |
| VPC network access failure | Timeout to external | Missing NAT gateway / endpoints | Add NAT or VPC endpoints for required services |
| Async lost events | No destination / DLQ | Config not set | Configure OnFailure destination or DLQ |

---

## 20. Cleanup Sequences

### 20.1 Delete alias & function (with versions)
```bash
aws lambda delete-alias --function-name hello-api --name prod 2>/dev/null || true
# Delete non-$LATEST versions
aws lambda list-versions-by-function --function-name hello-api \
  --query 'Versions[?Version!=`$LATEST`].Version' --output text | tr '\t' '\n' | \
  while read V; do
    aws lambda delete-function --function-name hello-api --qualifier "$V"
  done
# Delete function
aws lambda delete-function --function-name hello-api
```

### 20.2 Remove event source mappings
```bash
aws lambda list-event-source-mappings --function-name hello-api \
  --query 'EventSourceMappings[].UUID' --output text | tr '\t' '\n' | \
  while read U; do
    aws lambda delete-event-source-mapping --uuid "$U"
  done
```

### 20.3 Delete layer versions
```bash
aws lambda list-layer-versions --layer-name hello-layer \
  --query 'LayerVersions[].Version' --output text | tr '\t' '\n' | \
  while read LV; do
    aws lambda delete-layer-version --layer-name hello-layer --version-number "$LV"
  done
```

### 20.4 Detach & delete IAM role
```bash
aws iam list-attached-role-policies --role-name $ROLE_NAME \
  --query 'AttachedPolicies[].PolicyArn' --output text | tr '\t' '\n' | \
  while read P; do
    aws iam detach-role-policy --role-name $ROLE_NAME --policy-arn "$P"
  done
aws iam delete-role --role-name $ROLE_NAME
```

---

## 21. Appendix: Example Trust Policy (JSON)
(Already shown; repeated here for completeness.)
```json
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Principal":{"Service":"lambda.amazonaws.com"},
      "Action":"sts:AssumeRole"
    }
  ]
}
```

---

## 22. Notes
- Use `--cli-binary-format raw-in-base64-out` when payload special characters appear.
- Keep deployment artifacts immutable by including commit SHAs in zip or image tags.
- Prefer environment variables for non-secret config; use Secrets Manager / Parameter Store for secrets.
- Layers max combined unzipped size currently 250 MB (with function).
- Use CloudWatch Logs Insights for deeper log analytics queries.
- Consider Step Functions for orchestration instead of complex Lambda chaining.
- Provisioned concurrency reduces cold starts; evaluate cost tradeoff.
- For high-performance HTTP, consider Lambda Function URLs or API Gateway.

---
