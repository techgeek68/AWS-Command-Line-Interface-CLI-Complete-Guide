# AWS CLI — SSM (AWS Systems Manager) Operations Guide

---
> Session Manager, Run Command, Parameters, Automation, Patch, Inventory, Maintenance Windows, Ops, and cleanup.
---
> Replace 123456789012 with your AWS Account ID, and adjust Region (us-east-1) as needed.
---

## Table of Contents
1. [Overview](#overview)
2. [Prerequisites](#prerequisites)
3. [Session Manager](#session-manager)
4. [Port & File Operations with Session Manager](#port--file-operations-with-session-manager)
5. [Run Command](#run-command)
6. [SSM Documents](#ssm-documents)
7. [Automation](#automation)
8. [Patch Manager](#patch-manager)
9. [Inventory & Compliance](#inventory--compliance)
10. [Maintenance Windows](#maintenance-windows)
11. [Parameter Store](#parameter-store)
12. [Ops Center / Incident Manager (Basics)](#ops-center--incident-manager-basics)
13. [Quick Setup & Fleet Manager (Pointers)](#quick-setup--fleet-manager-pointers)
14. [Best Practices](#best-practices)
15. [Troubleshooting](#troubleshooting)
16. [Cleanup Sequences](#cleanup-sequences)
17. [Notes](#notes)

---

## Overview
AWS Systems Manager provides a unified interface to operate, manage, and secure EC2 instances, on‑prem servers (hybrid), and other resources.

Core concepts:
- Managed node: Instance / server with SSM Agent + IAM permissions.
- Documents: JSON/YAML (Command / Session / Automation / Package / Policy).
- Run Command: Ad‑hoc, no SSH needed.
- Session Manager: Interactive shell & port forwarding with logging.
- Parameter Store: Hierarchical configuration, secrets (String / SecureString).
- Automation: Workflow engine (patching, AMI creation, compliance).
- Patch Manager & Maintenance Windows: Controlled patch operations.
- Inventory & Compliance: Metadata & drift/compliance status.

---

## Prerequisites
1. Instance SSM Agent installed (Amazon Linux 2 AMIs already include).
2. Instance IAM role (e.g., `EC2SSMCoreRole`) with `AmazonSSMManagedInstanceCore`.
3. (Optional) KMS key for SecureString: `alias/ssm-parameters`.
4. CLI region: `aws configure set region us-east-1`.

Check managed nodes:
Syntax:
```bash
aws ssm describe-instance-information --query 'InstanceInformationList[].InstanceId'
```
Example:
```bash
aws ssm describe-instance-information --query 'InstanceInformationList[].InstanceId'
# Output: ["i-0a1b2c3d4e5f67890","i-0123abcd4567efgh8"]
```

---

## Session Manager

### Start an interactive shell session
Syntax:
```bash
aws ssm start-session --target <INSTANCE_ID>
```
Example:
```bash
aws ssm start-session --target i-0a1b2c3d4e5f67890
```

### Specify a profile & document (Windows PowerShell)
Syntax:
```bash
aws ssm start-session --profile <PROFILE> --target <INSTANCE_ID> \
  --document-name AWS-StartInteractiveCommand --parameters 'command=["powershell.exe"]'
```
Example:
```bash
aws ssm start-session --profile prod-admin --target i-0456e7fa89bc01234 \
  --document-name AWS-StartInteractiveCommand --parameters 'command=["powershell.exe"]'
```

### Enable CloudWatch logging (service setting example)
Syntax:
```bash
aws ssm put-service-setting \
  --setting-id /ssm/managed-instance/session-manager/logging/cloudwatch/enabled \
  --setting-value true
```
Example (enable S3 logging too):
```bash
aws ssm put-service-setting \
  --setting-id /ssm/managed-instance/session-manager/logging/s3/enabled \
  --setting-value true
```

### List active sessions
Syntax:
```bash
aws ssm describe-sessions --state Active
```
Example (filtered):
```bash
aws ssm describe-sessions --state Active \
  --query 'Sessions[].{Id:SessionId,Target:Target,Start:StartDate}'
```

### Terminate a session
Syntax:
```bash
aws ssm terminate-session --session-id <SESSION_ID>
```
Example:
```bash
aws ssm terminate-session --session-id ssm-session-0f1e2d3c4b5a67890
```

---

## Port & File Operations with Session Manager

### Port forwarding (local -> remote PostgreSQL 5432)
Syntax:
```bash
aws ssm start-session --target <INSTANCE_ID> \
  --document-name AWS-StartPortForwardingSession \
  --parameters '{"portNumber":["<REMOTE_PORT>"],"localPortNumber":["<LOCAL_PORT>"]}'
```
Example:
```bash
aws ssm start-session --target i-0a1b2c3d4e5f67890 \
  --document-name AWS-StartPortForwardingSession \
  --parameters '{"portNumber":["5432"],"localPortNumber":["15432"]}'
```

### Copy script TO instance (S3 then Run Command)
Syntax:
```bash
aws ssm send-command --instance-ids <INSTANCE_ID> --document-name AWS-RunShellScript \
  --parameters commands='["aws s3 cp s3://<BUCKET>/<KEY> </dest/path>","chmod +x </dest/path>"]'
```
Example:
```bash
aws ssm send-command \
  --instance-ids i-0456e7fa89bc01234 \
  --document-name AWS-RunShellScript \
  --comment "Fetch deployment script" \
  --parameters commands='["aws s3 cp s3://platform-artifacts/scripts/deploy.sh /usr/local/bin/deploy.sh","chmod +x /usr/local/bin/deploy.sh"]'
```

### Retrieve file FROM instance (upload to S3)
Syntax:
```bash
aws ssm send-command --instance-ids <INSTANCE_ID> --document-name AWS-RunShellScript \
  --parameters commands='["aws s3 cp <SOURCE_FILE> s3://<BUCKET>/<KEY>"]'
```
Example:
```bash
aws ssm send-command \
  --instance-ids i-0a1b2c3d4e5f67890 \
  --document-name AWS-RunShellScript \
  --parameters commands='["aws s3 cp /var/log/secure s3://ops-log-exports/i-0a1b2c3d4e5f67890/secure"]'
```

---

## Run Command

### Simple shell command
Syntax:
```bash
aws ssm send-command --instance-ids <INSTANCE_ID> \
  --document-name AWS-RunShellScript --parameters commands='["<CMD>"]'
```
Example:
```bash
aws ssm send-command --instance-ids i-0a1b2c3d4e5f67890 \
  --document-name AWS-RunShellScript \
  --comment "Health check" \
  --parameters commands='["uptime","df -h | head -n 5"]'
```

### Multiple instances via tag
Syntax:
```bash
aws ssm send-command --targets "Key=tag:<KEY>,Values=<VALUE>" \
  --document-name AWS-RunShellScript --parameters commands='["<CMD1>","<CMD2>"]'
```
Example:
```bash
aws ssm send-command \
  --targets "Key=tag:Env,Values=Dev" \
  --document-name AWS-RunShellScript \
  --comment "Kernel version query" \
  --parameters commands='["uname -r","cat /etc/os-release | grep PRETTY_NAME"]'
```

### Output to S3 & CloudWatch
Example:
```bash
aws ssm send-command \
  --instance-ids i-0456e7fa89bc01234 \
  --document-name AWS-RunShellScript \
  --parameters commands='["cat /proc/loadavg"]' \
  --cloud-watch-output-config CloudWatchLogGroupName=/ssm/run-command,CloudWatchOutputEnabled=true \
  --output-s3-bucket-name ops-ssm-output \
  --output-s3-key-prefix loadavg
```

### List recent commands
Example:
```bash
aws ssm list-commands --max-results 5 \
  --query 'Commands[].{Id:CommandId,Status:Status,Comment:Comment,Targets:Targets[0].Key}'
```

### Capture latest Command ID
Example:
```bash
CMD_ID=$(aws ssm list-commands --query 'Commands[0].CommandId' --output text)
echo "$CMD_ID"
```

### Get invocation output
Syntax:
```bash
aws ssm get-command-invocation --command-id <CMD_ID> --instance-id <INSTANCE_ID>
```
Example:
```bash
aws ssm get-command-invocation \
  --command-id $CMD_ID \
  --instance-id i-0a1b2c3d4e5f67890 \
  --query '{Status:Status,StdOut:StandardOutputContent,StdErr:StandardErrorContent}'
```

### Cancel command
Syntax:
```bash
aws ssm cancel-command --command-id <CMD_ID>
```
Example:
```bash
aws ssm cancel-command --command-id c8e1f5d3-1111-2222-aaaa-9f0eexample
```

---

## SSM Documents

### List AWS-owned documents
Example:
```bash
aws ssm list-documents \
  --document-filter-list key=Owner,value=Amazon \
  --max-results 10 \
  --query 'DocumentIdentifiers[].Name'
```

### Describe a document
Example:
```bash
aws ssm describe-document --name AWS-RunShellScript \
  --query '{Name:Document.Name,Type:Document.DocumentType,Version:Document.DocumentVersion}'
```

### Get document content
Example:
```bash
aws ssm get-document --name AWS-RunShellScript --query Content --output text | head
```

### Create custom Command document
File: MyEchoDoc.yaml (unchanged)
```yaml
---
schemaVersion: '2.2'
description: "Echo a provided message"
parameters:
  Message:
    type: String
    description: "Message to echo"
mainSteps:
  - action: aws:runShellScript
    name: EchoMessage
    inputs:
      runCommand:
        - echo "{{ Message }}"
```
Create (example):
```bash
aws ssm create-document \
  --name MyEchoDoc \
  --document-type Command \
  --content file://MyEchoDoc.yaml \
  --tags Key=Owner,Value=Platform
```

### Update document & set default
Example:
```bash
aws ssm update-document --name MyEchoDoc --content file://MyEchoDoc.yaml
aws ssm update-document-default-version --name MyEchoDoc --document-version "$LATEST"
```

### Delete document
Example:
```bash
aws ssm delete-document --name MyEchoDoc
```

---

## Automation

### List automation docs (subset)
Example:
```bash
aws ssm list-documents \
  --document-filter-list key=DocumentType,value=Automation \
  --query 'DocumentIdentifiers[0:8].Name'
```

### Start patch automation
Example:
```bash
aws ssm start-automation-execution \
  --document-name AWS-RunPatchBaseline \
  --parameters 'Operation=Install' \
  --targets 'Key=tag:PatchGroup,Values=LinuxServers'
```

### Create AMI automation doc (shown earlier)
Create:
```bash
aws ssm create-document \
  --name CreateAmiAutomation \
  --document-type Automation \
  --content file://CreateAmiAutomation.json
```

### Track executions
Example list:
```bash
aws ssm describe-automation-executions \
  --query 'AutomationExecutionMetadataList[0:3].{Id:AutomationExecutionId,Status:AutomationExecutionStatus,Doc:DocumentName}'
```

### Execution detail
Syntax:
```bash
aws ssm get-automation-execution --automation-execution-id <EXEC_ID>
```
Example:
```bash
aws ssm get-automation-execution \
  --automation-execution-id 11112222-3333-4444-aaaa-bbbbccccdddd \
  --query 'AutomationExecution.{Status:AutomationExecutionStatus,Step:CurrentStepName}'
```

---

## Patch Manager

### List baselines
Example:
```bash
aws ssm describe-patch-baselines \
  --query 'BaselineIdentities[].{Id:BaselineId,Name:BaselineName,Default:DefaultBaseline}'
```

### Default baseline (Amazon Linux 2)
Example:
```bash
aws ssm get-default-patch-baseline --operating-system AMAZON_LINUX_2 \
  --query '{BaselineId:BaselineId,OS:OperatingSystem}'
```

### Tag instance into patch group
Example:
```bash
aws ec2 create-tags --resources i-0456e7fa89bc01234 \
  --tags Key=PatchGroup,Value=LinuxServers
```

### On-demand patch (Run Command)
Example:
```bash
aws ssm send-command \
  --document-name AWS-RunPatchBaseline \
  --parameters Operation=Install \
  --targets "Key=tag:PatchGroup,Values=LinuxServers"
```

### Instance patch compliance
Example:
```bash
aws ssm describe-instance-patches \
  --instance-id i-0456e7fa89bc01234 \
  --max-results 10 \
  --query 'Patches[0:5].[Title,State]'
```

---

## Inventory & Compliance

### Enable inventory (Association)
Example:
```bash
aws ssm create-association \
  --name AWS-GatherSoftwareInventory \
  --targets "Key=InstanceIds,Values=i-0a1b2c3d4e5f67890" \
  --schedule-expression "rate(12 hours)" \
  --association-name InventoryCollection
```

### Application inventory sample
Example:
```bash
aws ssm list-inventory-entries \
  --instance-id i-0a1b2c3d4e5f67890 \
  --type-name AWS:Application \
  --query 'Entries[0:3]'
```

### Compliance summary list
Example:
```bash
aws ssm list-compliance-summaries \
  --query 'ComplianceSummaryItems[].{Type:ComplianceType,Compliant:CompliantSummary.CompliantCount,NonCompliant:NonCompliantSummary.NonCompliantCount}'
```

---

## Maintenance Windows

### Create window
Example:
```bash
aws ssm create-maintenance-window \
  --name LinuxPatchWindow \
  --schedule "cron(0 3 ? * SUN *)" \
  --duration 2 \
  --cutoff 1 \
  --allow-unassociated-targets
```

### Capture window ID
Example:
```bash
MW_ID=$(aws ssm describe-maintenance-windows \
  --query 'WindowIdentities[?Name==`LinuxPatchWindow`].WindowId' --output text)
echo $MW_ID
# e.g. mw-0abcd1234ef567890
```

### Register target
Example:
```bash
aws ssm register-target-with-maintenance-window \
  --window-id $MW_ID \
  --resource-type INSTANCE \
  --targets "Key=tag:PatchGroup,Values=LinuxServers"
```

### Register patch task
Example:
```bash
aws ssm register-task-with-maintenance-window \
  --window-id $MW_ID \
  --targets "Key=tag:PatchGroup,Values=LinuxServers" \
  --task-arn AWS-RunPatchBaseline \
  --task-type RUN_COMMAND \
  --max-concurrency 5 \
  --max-errors 1 \
  --priority 1 \
  --name PatchTask \
  --task-invocation-parameters '{"RunCommand":{"Parameters":{"Operation":["Install"]}}}'
```

### List executions
Example:
```bash
aws ssm describe-maintenance-window-executions \
  --window-id $MW_ID \
  --max-results 2 \
  --query 'WindowExecutions[].{Id:WindowExecutionId,Status:Status}'
```

---

## Parameter Store

### Put String
Syntax:
```bash
aws ssm put-parameter --name <NAME> --value <VALUE> --type String --overwrite
```
Example:
```bash
aws ssm put-parameter \
  --name /apps/webapi/dev/apiUrl \
  --value https://dev-api.example.com \
  --type String \
  --overwrite
```

### Put SecureString
Example:
```bash
aws ssm put-parameter \
  --name /apps/webapi/dev/dbPassword \
  --value 'Sup3rS3cret!' \
  --type SecureString \
  --key-id alias/ssm-parameters \
  --overwrite
```

### Get parameter (decrypt)
Example:
```bash
aws ssm get-parameter \
  --name /apps/webapi/dev/dbPassword \
  --with-decryption \
  --query 'Parameter.{Name:Name,Value:Value}'
```

### Get multiple
Example:
```bash
aws ssm get-parameters \
  --names /apps/webapi/dev/apiUrl /apps/webapi/dev/dbPassword \
  --with-decryption \
  --query 'Parameters[].{Name:Name,Value:Value}'
```

### Get by path
Example:
```bash
aws ssm get-parameters-by-path \
  --path /apps/webapi/dev/ \
  --recursive \
  --with-decryption \
  --query 'Parameters[].Name'
```

### Tag a parameter
Example:
```bash
aws ssm add-tags-to-resource \
  --resource-type Parameter \
  --resource-id /apps/webapi/dev/apiUrl \
  --tags Key=Owner,Value=Platform Key=Env,Value=Dev
```

### History
Example:
```bash
aws ssm get-parameter-history \
  --name /apps/webapi/dev/apiUrl \
  --query 'Parameters[].{Version:Version,Modified:LastModifiedDate,Value:Value}'
```

### Delete parameters
Example:
```bash
aws ssm delete-parameters --names /apps/webapi/dev/apiUrl /apps/webapi/dev/dbPassword
```

### Advanced parameter (Expiration policy)
Example:
```bash
aws ssm put-parameter \
  --name /apps/webapi/dev/tempFlag \
  --value enabled \
  --type String \
  --policies '[{"Type":"Expiration","Version":"1.0","Attributes":{"Timestamp":"2025-12-31T23:59:59Z"}}]' \
  --overwrite
```

---

## Ops Center / Incident Manager (Basics)

### List OpsItems
Example:
```bash
aws ssm describe-ops-items --max-results 5 \
  --query 'OpsItemSummaries[].{Id:OpsItemId,Status:Status,Title:Title}'
```

### Get OpsItem
Example:
```bash
aws ssm get-ops-item --ops-item-id oi-0abc12def34567890 \
  --query 'OpsItem.{Title:Title,Status:Status,Severity:Severity}'
```

---

## Quick Setup & Fleet Manager (Pointers)
Example metadata listing:
```bash
aws ssm list-ops-metadata --max-results 5 \
  --query 'OpsMetadataList[].ResourceId'
```

---

## Best Practices
- Close inbound SSH (22) and rely on Session Manager.
- Enable session & command logging to CloudWatch + encrypted S3.
- Use hierarchical parameter naming: `/apps/<app>/<env>/<component>/<name>`.
- KMS‑encrypt secrets (customer-managed key).
- Apply `max-concurrency` & `max-errors` to control blast radius for Run Command / Maintenance Windows.
- Tag everything for cost, ownership, environment, and lifecycle.
- Use Automation for repeatable AMI bake & patch flows.
- Regularly rotate SecureString secrets (versioning helps rollback).
- Restrict Parameter Store IAM (resource-level conditions: `ssm:ResourceTag`, path prefix).
- Use Inventory + Compliance to detect drift & unpatched systems.
- Prefer AWS-provided baseline automation docs then extend with custom steps.

---

## Troubleshooting
| Issue | Cause | Resolution |
|-------|-------|-----------|
| Instance missing from `describe-instance-information` | No IAM role / blocked endpoints / agent stopped | Attach `AmazonSSMManagedInstanceCore`; verify VPC endpoints (`ssm`, `ec2messages`, `ssmmessages`); restart agent |
| `start-session` AccessDenied | Role lacks required permissions | Ensure managed policy attached; trust policy correct |
| Session unexpected disconnect | Idle timeout / network | Adjust Session Manager preferences; check security controls |
| Run Command `DeliveryTimedOut` | Instance offline or unreachable | Verify instance health, agent logs (`/var/log/amazon/ssm/amazon-ssm-agent.log`) |
| Empty command output | Logging misconfigured | Enable CloudWatch & S3 output; verify bucket policy |
| `ParameterNotFound` | Path typo or missing leading slash | Validate exact name with `get-parameters-by-path` |
| `ThrottlingException` | High API concurrency | Add backoff; segment fleet; use State Manager |
| Automation fails assume role | Role trust lacks `ssm.amazonaws.com` | Add to trust JSON and retry |
| Patch compliance empty | Patch group not tagged or wrong OS baseline | Confirm `PatchGroup` tag & baseline OS matches instance |
| Maintenance window inactive | Schedule not yet triggered / no targets | Check cron in UTC; confirm target registration |

---

## Cleanup Sequences

### Remove custom Command document
Example:
```bash
aws ssm delete-document --name MyEchoDoc
```

### Cancel all in-progress commands
Example:
```bash
aws ssm list-commands --query 'Commands[?Status==`InProgress`].CommandId' --output text | \
  xargs -r -n1 -I{} aws ssm cancel-command --command-id {}
```

### Delete parameters under a path
Example:
```bash
aws ssm get-parameters-by-path --path /apps/webapi/dev/ --recursive \
  --query 'Parameters[].Name' --output text | \
  xargs -r -n1 -I{} aws ssm delete-parameter --name {}
```

### Delete maintenance window (with tasks & targets)
Example:
```bash
MW_ID=mw-0abcd1234ef567890
aws ssm describe-maintenance-window-tasks --window-id $MW_ID \
  --query 'Tasks[].WindowTaskId' --output text | \
  xargs -r -n1 -I{} aws ssm deregister-task-from-maintenance-window --window-id $MW_ID --window-task-id {}
aws ssm describe-maintenance-window-targets --window-id $MW_ID \
  --query 'Targets[].WindowTargetId' --output text | \
  xargs -r -n1 -I{} aws ssm deregister-target-from-maintenance-window --window-id $MW_ID --window-target-id {}
aws ssm delete-maintenance-window --window-id $MW_ID
```

### Remove Automation document
Example:
```bash
aws ssm delete-document --name CreateAmiAutomation
```

---

## Notes
- SecureString decrypt requires `ssm:GetParameter(s)` + `kms:Decrypt` on key.
- Hybrid activation example:
  ```bash
  aws ssm create-activation --default-instance-name OnPremLinux --iam-role SSMOnPremRole --registration-limit 5
  ```
- Install Session Manager plugin for advanced features (port forwarding).
- Prefer State Manager + Maintenance Windows for routine tasks vs. repeated ad‑hoc commands.
- Monitor CloudTrail for `StartSession`, `SendCommand`, and parameter access patterns.

---
