# AWS CLI â€“ CloudFormation Guide

## Table of Contents
1. [Overview](#overview)
2. [Deploying Stacks](#1-deploying-stacks)
3. [Packaging](#2-packaging-for-local-artifacts)
4. [Change Sets](#3-change-sets)
5. [Stack Outputs & Resources](#4-stack-outputs--resources)
6. [Deleting Stacks](#5-deleting-stacks)
7. [Drift Detection](#6-drift-detection)
8. [Best Practices](#7-best-practices)
9. [Troubleshooting](#8-troubleshooting)

---

## Overview
AWS CloudFormation provisions infrastructure as code using declarative templates (YAML/JSON). The CLI supports packaging, deploying, change set review, and stack introspection.

---

## 1. Deploying Stacks
Basic deploy:
```bash
aws cloudformation deploy \
  --template-file template.yaml \
  --stack-name MyStack \
  --capabilities CAPABILITY_IAM
```

Parameters:
```bash
aws cloudformation deploy \
  --template-file template.yaml \
  --stack-name MyStack \
  --parameter-overrides Env=prod InstanceType=t3.micro \
  --capabilities CAPABILITY_NAMED_IAM
```

PowerShell:
```powershell
aws.exe cloudformation deploy --template-file template.yaml --stack-name MyStack --capabilities CAPABILITY_IAM
```

---

## 2. Packaging (For Local Artifacts)
```bash
aws cloudformation package \
  --template-file template.yaml \
  --s3-bucket my-artifacts-bucket \
  --output-template-file packaged.yaml
```

Deploy packaged:
```bash
aws cloudformation deploy \
  --template-file packaged.yaml \
  --stack-name MyStack \
  --capabilities CAPABILITY_IAM
```

---

## 3. Change Sets
Create:
```bash
aws cloudformation create-change-set \
  --stack-name MyStack \
  --change-set-name MyChangeSet \
  --template-body file://template.yaml \
  --capabilities CAPABILITY_IAM
```

Describe:
```bash
aws cloudformation describe-change-set --stack-name MyStack --change-set-name MyChangeSet
```

Execute:
```bash
aws cloudformation execute-change-set --stack-name MyStack --change-set-name MyChangeSet
```

---

## 4. Stack Outputs & Resources
Describe stack:
```bash
aws cloudformation describe-stacks --stack-name MyStack
```

Outputs only:
```bash
aws cloudformation describe-stacks \
  --stack-name MyStack \
  --query "Stacks[0].Outputs"
```

List resources:
```bash
aws cloudformation list-stack-resources --stack-name MyStack
```

---

## 5. Deleting Stacks
```bash
aws cloudformation delete-stack --stack-name MyStack
aws cloudformation wait stack-delete-complete --stack-name MyStack
```

---

## 6. Drift Detection
Start:
```bash
aws cloudformation detect-stack-drift --stack-name MyStack
```

Status:
```bash
aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id <ID>
```

List drifts:
```bash
aws cloudformation describe-stack-resource-drifts --stack-name MyStack
```

---

## 7. Best Practices
- Use change sets for production safety.
- Modularize templates (nested stacks).
- Parameterize environment values.
- Use exports sparingly to avoid tight coupling.
- Apply tags: `--tags Key=Env,Value=Prod`.
- Lint templates (`cfn-lint`).

---

## 8. Troubleshooting
| Issue | Cause | Fix |
|-------|-------|-----|
| ROLLBACK_COMPLETE | Resource failure | Inspect stack events |
| Export name conflict | Duplicate export | Rename / remove old export |
| InsufficientCapabilities | Missing flag | Add `--capabilities CAPABILITY_IAM`/`NAMED_IAM` |
| Artifact missing | Packaging mismatch | Re-run `package` command |
| Drift incomplete | Detection running | Poll status until complete |

Recent events:
```bash
aws cloudformation describe-stack-events --stack-name MyStack --max-items 20
```

---
